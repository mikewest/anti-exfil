<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <title>Connection Allowlists</title>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <link href="https://www.w3.org/StyleSheets/TR/2021/W3C-UD" rel="stylesheet">
  <meta content="Bikeshed version 86e3be07a, updated Tue Nov 18 16:58:08 2025 +0000" name="generator">
  <link href="https://wicg.github.io/connection-allowlists/" rel="canonical">
  <meta content="43493c2a9d7eafa7820da4684b5fa0e51980fa1c" name="revision">
  <meta content="dark light" name="color-scheme">
  <link href="https://www.w3.org/StyleSheets/TR/2021/dark.css" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css">
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */
/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example " counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
    --dfnpanel-target-bg: #ffc;
    --dfnpanel-target-outline: orange;
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
        --dfnpanel-target-bg: #333;
        --dfnpanel-target-outline: silver;
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel a:focus {
    outline: 5px auto Highlight;
    outline: 5px auto -webkit-focus-ring-color;
}
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: 8px;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
    transition: left 1s ease-out, bottom 1s ease-out;
}

.dfn-panel .link-item:hover {
    text-decoration: underline;
}
.dfn-panel .link-item .copy-icon {
    opacity: 0;
}
.dfn-panel .link-item:hover .copy-icon,
.dfn-panel .link-item .copy-icon:focus {
    opacity: 1;
}

.dfn-panel .copy-icon {
    display: inline-block;
    margin-right: 0.5em;
    width: 0.85em;
    height: 1em;
    border-radius: 3px;
    background-color: #ccc;
    cursor: pointer;
}

.dfn-panel .copy-icon .icon {
    width: 100%;
    height: 100%;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.dfn-panel .copy-icon .icon::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid black;
    background-color: #ccc;
    opacity: 0.25;
    transform: translate(3px, -3px);
}

.dfn-panel .copy-icon:active .icon::before {
    opacity: 1;
}

.dfn-paneled[role="button"] { cursor: help; }

.highlighted {
    animation: target-fade 3s;
}

@keyframes target-fade {
    from {
        background-color: var(--dfnpanel-target-bg);
        outline: 5px solid var(--dfnpanel-target-outline);
    }
    to {
        color: var(--a-normal-text);
        background-color: transparent;
        outline: transparent;
    }
}
</style>
<style>/* Boilerplate: style-idl-highlighting */
pre.idl.highlight {
    background: var(--borderedblock-bg, var(--def-bg));
}
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-ref-hints */
:root {
    --ref-hint-bg: #ddd;
    --ref-hint-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --ref-hint-bg: #222;
        --ref-hint-text: var(--text);
    }
}

.ref-hint {
    display: inline-block;
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.5em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--ref-hint-bg);
    color: var(--ref-hint-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}

.ref-hint * { margin: 0; padding: 0; text-indent: 0; }

.ref-hint ul { padding: 0 0 0 1em; list-style: none; }
</style>
<style>/* Boilerplate: style-selflinks */
:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* Boilerplate: style-syntax-highlighting */
code.highlight { padding: .1em; border-radius: .3em; }
pre.highlight, pre > code.highlight { display: block; padding: 1em; margin: .5em 0; overflow: auto; border-radius: 0; }

.highlight:not(.idl) { background: rgba(0, 0, 0, .03); }
c-[a] { color: #990055 } /* Keyword.Declaration */
c-[b] { color: #990055 } /* Keyword.Type */
c-[c] { color: #708090 } /* Comment */
c-[d] { color: #708090 } /* Comment.Multiline */
c-[e] { color: #0077aa } /* Name.Attribute */
c-[f] { color: #669900 } /* Name.Tag */
c-[g] { color: #222222 } /* Name.Variable */
c-[k] { color: #990055 } /* Keyword */
c-[l] { color: #000000 } /* Literal */
c-[m] { color: #000000 } /* Literal.Number */
c-[n] { color: #0077aa } /* Name */
c-[o] { color: #999999 } /* Operator */
c-[p] { color: #999999 } /* Punctuation */
c-[s] { color: #a67f59 } /* Literal.String */
c-[t] { color: #a67f59 } /* Literal.String.Single */
c-[u] { color: #a67f59 } /* Literal.String.Double */
c-[cp] { color: #708090 } /* Comment.Preproc */
c-[c1] { color: #708090 } /* Comment.Single */
c-[cs] { color: #708090 } /* Comment.Special */
c-[kc] { color: #990055 } /* Keyword.Constant */
c-[kn] { color: #990055 } /* Keyword.Namespace */
c-[kp] { color: #990055 } /* Keyword.Pseudo */
c-[kr] { color: #990055 } /* Keyword.Reserved */
c-[ld] { color: #000000 } /* Literal.Date */
c-[nc] { color: #0077aa } /* Name.Class */
c-[no] { color: #0077aa } /* Name.Constant */
c-[nd] { color: #0077aa } /* Name.Decorator */
c-[ni] { color: #0077aa } /* Name.Entity */
c-[ne] { color: #0077aa } /* Name.Exception */
c-[nf] { color: #0077aa } /* Name.Function */
c-[nl] { color: #0077aa } /* Name.Label */
c-[nn] { color: #0077aa } /* Name.Namespace */
c-[py] { color: #0077aa } /* Name.Property */
c-[ow] { color: #999999 } /* Operator.Word */
c-[mb] { color: #000000 } /* Literal.Number.Bin */
c-[mf] { color: #000000 } /* Literal.Number.Float */
c-[mh] { color: #000000 } /* Literal.Number.Hex */
c-[mi] { color: #000000 } /* Literal.Number.Integer */
c-[mo] { color: #000000 } /* Literal.Number.Oct */
c-[sb] { color: #a67f59 } /* Literal.String.Backtick */
c-[sc] { color: #a67f59 } /* Literal.String.Char */
c-[sd] { color: #a67f59 } /* Literal.String.Doc */
c-[se] { color: #a67f59 } /* Literal.String.Escape */
c-[sh] { color: #a67f59 } /* Literal.String.Heredoc */
c-[si] { color: #a67f59 } /* Literal.String.Interpol */
c-[sx] { color: #a67f59 } /* Literal.String.Other */
c-[sr] { color: #a67f59 } /* Literal.String.Regex */
c-[ss] { color: #a67f59 } /* Literal.String.Symbol */
c-[vc] { color: #0077aa } /* Name.Variable.Class */
c-[vg] { color: #0077aa } /* Name.Variable.Global */
c-[vi] { color: #0077aa } /* Name.Variable.Instance */
c-[il] { color: #000000 } /* Literal.Number.Integer.Long */

@media (prefers-color-scheme: dark) {
    .highlight:not(.idl) { background: rgba(255, 255, 255, .05); }

    c-[a] { color: #d33682 } /* Keyword.Declaration */
    c-[b] { color: #d33682 } /* Keyword.Type */
    c-[c] { color: #2aa198 } /* Comment */
    c-[d] { color: #2aa198 } /* Comment.Multiline */
    c-[e] { color: #268bd2 } /* Name.Attribute */
    c-[f] { color: #b58900 } /* Name.Tag */
    c-[g] { color: #cb4b16 } /* Name.Variable */
    c-[k] { color: #d33682 } /* Keyword */
    c-[l] { color: #657b83 } /* Literal */
    c-[m] { color: #657b83 } /* Literal.Number */
    c-[n] { color: #268bd2 } /* Name */
    c-[o] { color: #657b83 } /* Operator */
    c-[p] { color: #657b83 } /* Punctuation */
    c-[s] { color: #6c71c4 } /* Literal.String */
    c-[t] { color: #6c71c4 } /* Literal.String.Single */
    c-[u] { color: #6c71c4 } /* Literal.String.Double */
    c-[ch] { color: #2aa198 } /* Comment.Hashbang */
    c-[cp] { color: #2aa198 } /* Comment.Preproc */
    c-[cpf] { color: #2aa198 } /* Comment.PreprocFile */
    c-[c1] { color: #2aa198 } /* Comment.Single */
    c-[cs] { color: #2aa198 } /* Comment.Special */
    c-[kc] { color: #d33682 } /* Keyword.Constant */
    c-[kn] { color: #d33682 } /* Keyword.Namespace */
    c-[kp] { color: #d33682 } /* Keyword.Pseudo */
    c-[kr] { color: #d33682 } /* Keyword.Reserved */
    c-[ld] { color: #657b83 } /* Literal.Date */
    c-[nc] { color: #268bd2 } /* Name.Class */
    c-[no] { color: #268bd2 } /* Name.Constant */
    c-[nd] { color: #268bd2 } /* Name.Decorator */
    c-[ni] { color: #268bd2 } /* Name.Entity */
    c-[ne] { color: #268bd2 } /* Name.Exception */
    c-[nf] { color: #268bd2 } /* Name.Function */
    c-[nl] { color: #268bd2 } /* Name.Label */
    c-[nn] { color: #268bd2 } /* Name.Namespace */
    c-[py] { color: #268bd2 } /* Name.Property */
    c-[ow] { color: #657b83 } /* Operator.Word */
    c-[mb] { color: #657b83 } /* Literal.Number.Bin */
    c-[mf] { color: #657b83 } /* Literal.Number.Float */
    c-[mh] { color: #657b83 } /* Literal.Number.Hex */
    c-[mi] { color: #657b83 } /* Literal.Number.Integer */
    c-[mo] { color: #657b83 } /* Literal.Number.Oct */
    c-[sa] { color: #6c71c4 } /* Literal.String.Affix */
    c-[sb] { color: #6c71c4 } /* Literal.String.Backtick */
    c-[sc] { color: #6c71c4 } /* Literal.String.Char */
    c-[dl] { color: #6c71c4 } /* Literal.String.Delimiter */
    c-[sd] { color: #6c71c4 } /* Literal.String.Doc */
    c-[se] { color: #6c71c4 } /* Literal.String.Escape */
    c-[sh] { color: #6c71c4 } /* Literal.String.Heredoc */
    c-[si] { color: #6c71c4 } /* Literal.String.Interpol */
    c-[sx] { color: #6c71c4 } /* Literal.String.Other */
    c-[sr] { color: #6c71c4 } /* Literal.String.Regex */
    c-[ss] { color: #6c71c4 } /* Literal.String.Symbol */
    c-[fm] { color: #268bd2 } /* Name.Function.Magic */
    c-[vc] { color: #cb4b16 } /* Name.Variable.Class */
    c-[vg] { color: #cb4b16 } /* Name.Variable.Global */
    c-[vi] { color: #cb4b16 } /* Name.Variable.Instance */
    c-[vm] { color: #cb4b16 } /* Name.Variable.Magic */
    c-[il] { color: #657b83 } /* Literal.Number.Integer.Long */
}
</style>
<style>/* Boilerplate: style-var-click-highlighting */
/*
Colors were chosen in Lab using https://nixsensor.com/free-color-converter/
D50 2deg illuminant, L in [0,100], a and b in [-128, 128]
0 = lab(85,0,85)
1 = lab(85,80,30)
2 = lab(85,-40,40)
3 = lab(85,-50,0)
4 = lab(85,5,15)
5 = lab(85,-10,-50)
6 = lab(85,35,-15)

For darkmode:
0 = oklab(50%   0%  108%)
1 = oklab(50% -51%   51%)
2 = oklab(50% -64%  -20%)
3 = oklab(50%   6%   19%)
4 = oklab(50% -12%  -64%)
5 = oklab(50%  44%  -19%)  
6 = oklab(50% 102%   38%)
*/

[data-algorithm] var { cursor: pointer; }
var[data-var-color] { background-color: var(--var-bg); box-shadow: 0 0 0 2px var(--var-bg); }

var[data-var-color] { --var-bg: #F4D200; }
var[data-var-color="1"] { --var-bg: #FF87A2; }
var[data-var-color="2"] { --var-bg: #96E885; }
var[data-var-color="3"] { --var-bg: #3EEED2; }
var[data-var-color="4"] { --var-bg: #EACFB6; }
var[data-var-color="5"] { --var-bg: #82DDFF; }
var[data-var-color="6"] { --var-vg: #FFBCF2; }

@media (prefers-color-scheme: dark) {
	var[data-var-color] { --var-bg: #bc1a00; }
	var[data-var-color="1"] { --var-bg: #007f00; }
	var[data-var-color="2"] { --var-bg: #008698; }
	var[data-var-color="3"] { --var-bg: #7f5b2b; }
	var[data-var-color="4"] { --var-bg: #004df3; }
	var[data-var-color="5"] { --var-bg: #a1248a; }
	var[data-var-color="6"] { --var-vg: #ff0000; }
}
</style>
 <body class="h-entry">
  <div class="head">
   <h1 class="no-ref p-name" id="title">Connection Allowlists</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types/#UD">Unofficial Proposal Draft</a>,
    <time class="dt-updated" datetime="2025-11-25">25 November 2025</time></p>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>This version:
     <dd><a class="u-url" href="https://wicg.github.io/connection-allowlists/">https://wicg.github.io/connection-allowlists/</a>
     <dt>Issue Tracking:
     <dd><a href="https://github.com/wicg/connection-allowlists/issues/">GitHub</a>
     <dd><a href="#issues-index">Inline In Spec</a>
     <dt class="editor">Editor:
     <dd class="editor h-card p-author vcard"><span class="fn p-name">Mike West</span> (<span class="org p-org">Google</span>)
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 2025 the Contributors to the Connection Allowlists Specification, published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a> under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>.
A human-readable <a href="http://www.w3.org/community/about/agreements/cla-deed/">summary</a> is available.
</p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="heading no-num no-ref no-toc settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>The <code>Connection-Allowlist</code> mechanism provides a concise policy language and delivery mechanism
for a set of constraints on a context’s ability to communicate with other servers. The goal is
to provide developers with the ability to holistically mitigate explicit exfiltration channels
in a way that’s narrowly tailored to suit the problem.</p>
  </div>
  <div data-fill-with="at-risk"></div>
  <h2 class="heading no-num no-ref no-toc settled" id="status"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p>
  This specification was published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a>.
  It is not a W3C Standard nor is it on the W3C Standards Track.

  Please note that under the
  <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>
  there is a limited opt-out and other conditions apply.

  Learn more about
  <a href="http://www.w3.org/community/">W3C Community and Business Groups</a>.
</p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-ref no-toc" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li>
     <a href="#intro"><span class="secno">1</span> <span class="content">Introduction</span></a>
     <ol class="toc">
      <li><a href="#threat-model"><span class="secno">1.1</span> <span class="content">Threat Model</span></a>
      <li><a href="#overlap-with-csp"><span class="secno">1.2</span> <span class="content">Overlap with Content Security Policy</span></a>
     </ol>
    <li><a href="#allowlists"><span class="secno">2</span> <span class="content">Connection Allowlists</span></a>
    <li>
     <a href="#headers"><span class="secno">3</span> <span class="content">Connection Allowlist Headers</span></a>
     <ol class="toc">
      <li><a href="#parsing"><span class="secno">3.1</span> <span class="content">Parsing</span></a>
      <li><a href="#matching"><span class="secno">3.2</span> <span class="content">Matching</span></a>
      <li><a href="#reporting"><span class="secno">3.3</span> <span class="content">Reporting</span></a>
     </ol>
    <li>
     <a href="#monkey-patching"><span class="secno">4</span> <span class="content">Monkey-Patches</span></a>
     <ol class="toc">
      <li><a href="#fetch"><span class="secno">4.1</span> <span class="content">Integration with Fetch</span></a>
      <li><a href="#html"><span class="secno">4.2</span> <span class="content">Integration with HTML</span></a>
     </ol>
    <li>
     <a href="#questions"><span class="secno">5</span> <span class="content">Open Questions</span></a>
     <ol class="toc">
      <li><a href="#redirects"><span class="secno">5.1</span> <span class="content">Redirects</span></a>
     </ol>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
     </ol>
    <li><a href="#idl-index"><span class="secno"></span> <span class="content">IDL Index</span></a>
    <li><a href="#issues-index"><span class="secno"></span> <span class="content">Issues Index</span></a>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="intro"><span class="secno">1. </span><span class="content">Introduction</span><a class="self-link" href="#intro"></a></h2>
   <p>Developers wish to have control over the resources loaded into their pages' contexts and the
endpoints to which their pages can make requests. This control is necessary for several purposes,
including limiting the ways in which users' data can flow through the user agent (mitigating
exfiltration attacks) and ensuring control over a site’s architecture and depedencies.</p>
   <p>Content Security Policy addresses some of this need, but does so in a way that is more granular
than necessary for the most critical use cases, and with a syntax and grammar that’s complicated
by the other protections CSP is used to deploy. <a data-link-type="biblio" href="#biblio-csp" title="Content Security Policy Level 3">[CSP]</a></p>
   <p>`<code><a data-link-type="http-header" href="#http-headerdef-connection-allowlist" id="ref-for-http-headerdef-connection-allowlist">Connection-Allowlist</a></code>` steps back from CSP, and focuses on the single use case of controlling
the explicit requests a page may initiate through Fetch and other web platform APIs (WebRTC, Web
Transport, FedCM, Web Payments, DNS Prefetch, etc) in a way that aims to be straightforward and
comprehensive.</p>
   <div class="example" id="example-basic">
    <a class="self-link" href="#example-basic"></a>
  
<pre class="highlight language-http">NOTE: '\' line wrapping per RFC 8792

Connection-Allowlist: (response-origin "https://cdn.example" "https://*.example.:tld" \
                       "https://api.example:*"); report-to=ReportingAPIEndpoint
</pre>
    <p>This header, delivered along with a document to which a user has navigated, would restrict that
  document to allow requests and connections only to those endpoints which matched the URL patterns
  <a data-link-type="biblio" href="#biblio-urlpattern" title="URL Pattern Standard">[URLPATTERN]</a> specified in the list: the origin from which the document was delivered,
  <code>https://cdn.example</code>, ny subdomain of any host whose penultimate DNS label is <code>example</code>,
  <code>https://api.example</code> on any port, and so on.</p>
    <p>Attempts to connect to endpoints that don’t match the allowlist will be blocked, and reported via
  a Reporting API <a data-link-type="biblio" href="#biblio-reporting" title="Reporting API">[REPORTING]</a> <a data-link-type="dfn" href="https://w3c.github.io/reporting/#endpoint" id="ref-for-endpoint">endpoint</a> specified in the <code>report-to</code> parameter (and defined
  through a separate <a data-link-type="dfn" href="https://w3c.github.io/reporting/#reporting-endpoints" id="ref-for-reporting-endpoints">Reporting-Endpoints</a> header).</p>
   </div>
   <h3 class="heading settled" data-level="1.1" id="threat-model"><span class="secno">1.1. </span><span class="content">Threat Model</span><a class="self-link" href="#threat-model"></a></h3>
   <p>This proposal is intentionally small, targeting a specific but useful niche of client-side attacks
and/or misconfigurations:</p>
   <ul>
    <li data-md>
     <p>Policies for documents and workers will be asserted by servers as HTTP response headers. This
means that attackers who can manipulate response headers will remain out of scope.</p>
    <li data-md>
     <p>A document’s (or worker’s) asserted policy governs only requests initiated by _that_ context.
If a framed document asserts a distinct policy, so be it (with the caveat that this policy
will apply to contexts created via local schemes (<code>data:</code>, <code>about:</code>, etc.), similar to other
components of a context’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#policy-container" id="ref-for-policy-container">policy container</a>, which are handled by HTML when creating new
document/worker contexts.</p>
    <li data-md>
     <p>The connection and/or request are the threat the proposal aims to defend against. To be
effective as an exfiltration defense, we must block connections before they’re made.</p>
    <li data-md>
     <p>There are a plethora of side-channels available as unintended effects of otherwise-excellent
web platform APIs. This proposal does not attempt to address them, focusing instead soley on
those requests or connections explicitly initiated by the user agent on a page’s behalf. This
certainly includes the clear cases of <code class="idl"><a data-link-type="idl" href="https://fetch.spec.whatwg.org/#dom-global-fetch" id="ref-for-dom-global-fetch">fetch()</a></code> and <code class="idl"><a data-link-type="idl" href="https://xhr.spec.whatwg.org/#xmlhttprequest" id="ref-for-xmlhttprequest">XMLHttpRequest</a></code>, along with resource
requests generally. It also includes network connections established through channels that are
less explicitly "requests": manifests fetched through the Web Install API, connections to
TURN/STUN servers via WebRTC, Web Transport channels, navigations, and so on. These are all in
scope, while more esoteric channels like memory or CPU consumption, socket exhaustion, and
XSLeaks in general are not.</p>
    <li data-md>
     <p>This proposal addresses only communication channels. It does not aim to prevent (or even
substantially mitigate) threats like content injection or cross-site scripting. It only can
constrain the impact of such an attack _on those specific pages_ where the policy is in place,
and should be considered only as one layer in a page’s defenses; it won’t be sufficient in
itself.</p>
    <li data-md>
     <p>It’s tempting to attempt to defend against a subset of server-side threats, like open redirects.
It’s possible that we could do so in a proposal like this one, similar conceptually to what CSP
does today. That said, CSP’s behavior around redirects is both a leak in itself, and has
garnered inconsistently favorable feedback from developers and researchers alike. For
simplicity’s sake, this proposal will generally treat redirect responses as match failures. That
is, we’ll start with a draconian policy which will block any redirect response. It’s quite
probable that we’ll shift this one way or another as use cases crystalize.</p>
   </ul>
   <h3 class="heading settled" data-level="1.2" id="overlap-with-csp"><span class="secno">1.2. </span><span class="content">Overlap with Content Security Policy</span><a class="self-link" href="#overlap-with-csp"></a></h3>
   <p>This proposal has a lot in common with Content Security Policy’s approach to restrictions upon
resource usage within a given context, <a data-link-type="dfn" href="https://w3c.github.io/webappsec-csp/#fetch-directives" id="ref-for-fetch-directives">fetch directives</a> in particular. Still, it seems
reasonable to explore for a few reasons:</p>
   <ol>
    <li data-md>
     <p>CSP’s model is too granular: Developers who wish to mitigate the risk that data flows out of a
sensitive context require a protection that exhaustively covers the possible ways in which
requests can be made or connections established. CSP’s categorization of requests into types
which can be controlled in isolation is the wrong way to approach this problem, as data leaking
through a request for a web font is just as bad as data leaking through a request for an image
or a script. Distinguishing these request types complicates the process of designing a
reasonable defense with questions that are simply irrelevant.</p>
    <li data-md>
     <p>CSP’s syntax is not granular enough: The <a data-link-type="grammar" href="https://w3c.github.io/webappsec-csp/#grammardef-host-source" id="ref-for-grammardef-host-source"><code>host-source</code></a> grammar CSP supports leads
to truly verbose headers being delivered with responses. A distinct policy provides the
opportunity to shift to the URLPattern syntax which will resolve some complaints folks have
raised about CSP’s approach by providing a more modern, malleable, and standardized matching
syntax.</p>
    <li data-md>
     <p>CSP’s coverage is incomplete: While CSP does a good job covering HTTP requests which run
through Fetch, it does not exhaustively cover the myriad ways in which web platform APIs
allow connections to be established. DNS prefetch and WebRTC are good examples to start
with, but there are many others which have struggled with exactly how they fit into CSP’s
threat model. By creating a new policy with a narrow focus and explicit promise to developers,
these discussions will have a defensible answer and a clear mandate to specification authors.</p>
   </ol>
   <h2 class="heading settled" data-level="2" id="allowlists"><span class="secno">2. </span><span class="content">Connection Allowlists</span><a class="self-link" href="#allowlists"></a></h2>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="connection-allowlist">Connection Allowlist</dfn> represents the set of <a data-link-type="dfn" href="https://urlpattern.spec.whatwg.org/#url-pattern" id="ref-for-url-pattern">URL patterns</a> to which a given context
is allowed to connect. It is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#struct" id="ref-for-struct">struct</a> with the following <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#struct-item" id="ref-for-struct-item">items</a>:</p>
   <ul>
    <li data-md>
     <p><dfn class="dfn-paneled" data-dfn-for="Connection Allowlist" data-dfn-type="dfn" data-noexport id="connection-allowlist-allowlist">allowlist</dfn>, which is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list">list</a> of <a data-link-type="dfn" href="https://urlpattern.spec.whatwg.org/#url-pattern" id="ref-for-url-pattern①">URL patterns</a>. It is
an empty list unless otherwise specified.</p>
    <li data-md>
     <p><dfn class="dfn-paneled" data-dfn-for="Connection Allowlist" data-dfn-type="dfn" data-noexport id="connection-allowlist-reporting-endpoint">reporting endpoint</dfn>, which is either <code>null</code> or a Reporting
API <a data-link-type="dfn" href="https://w3c.github.io/reporting/#endpoint" id="ref-for-endpoint①">endpoint</a>. It is <code>null</code> unless otherwise specified.</p>
    <li data-md>
     <p><dfn class="dfn-paneled" data-dfn-for="Connection Allowlist" data-dfn-type="dfn" data-noexport id="connection-allowlist-disposition">disposition</dfn>, which is either
<dfn class="dfn-paneled" data-dfn-for="Connection Allowlist/disposition" data-dfn-type="grammar" data-export id="grammardef-connection-allowlist-disposition-enforce">enforce</dfn> or
<dfn class="dfn-paneled" data-dfn-for="Connection Allowlist/disposition" data-dfn-type="grammar" data-export id="grammardef-connection-allowlist-disposition-report">report</dfn>.</p>
   </ul>
   <h2 class="heading settled" data-level="3" id="headers"><span class="secno">3. </span><span class="content">Connection Allowlist Headers</span><a class="self-link" href="#headers"></a></h2>
   <p>The <dfn class="dfn-paneled" data-dfn-type="http-header" data-export id="http-headerdef-connection-allowlist">Connection-Allowlist</dfn> response <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header" id="ref-for-concept-header">header</a> contains a list of
serialized URL pattern strings that define the set of endpoints to which a context is allowed to
connect. This allowlist is enforced for a given context, blocking outgoing connections that don’t
match the asserted patterns. The <dfn class="dfn-paneled" data-dfn-type="http-header" data-export id="http-headerdef-connection-allowlist-report-only">Connection-Allowlist-Report-Only</dfn>
response <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header" id="ref-for-concept-header①">header</a> is a report-only variant, parsed in the same way, but only sending violation
reports without blocking outgoing connections.</p>
   <p>These Connection Allowlist headers are <a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc9651#name-introduction" id="ref-for-name-introduction">structured headers</a> whose values are a
<a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc9651#name-list" id="ref-for-name-list">list</a> of <a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc9651#name-inner-list" id="ref-for-name-inner-list">inner lists</a>. Servers may deliver a list with
an arbitrary number of items, but only the first will be used. Any additional items in the list
will be ignored.</p>
   <p>The <a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc9651#name-inner-list" id="ref-for-name-inner-list①">inner list</a> can contain either URL Patterns serialized as
<a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc9651#name-string" id="ref-for-name-string">strings</a>, or the <a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc9651#name-tokens" id="ref-for-name-tokens">token</a>
<dfn class="dfn-paneled" data-dfn-for="Connection-Allowlist" data-dfn-type="grammar" data-export id="grammardef-connection-allowlist-response-origin"><code>response-origin</code></dfn> which represents a pattern matching
the <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response" id="ref-for-concept-response">response</a>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-url" id="ref-for-concept-response-url">URL</a>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-origin" id="ref-for-concept-url-origin">origin</a>. Unexpected values will be ignored.</p>
   <p>The <a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc9651#name-inner-list" id="ref-for-name-inner-list②">inner list</a> may have arbitrary <a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc9651#name-parameters" id="ref-for-name-parameters">parameters</a>. The
<dfn class="dfn-paneled" data-dfn-for="Connection-Allowlist" data-dfn-type="grammar" data-export id="grammardef-connection-allowlist-report-to"><code>report-to</code></dfn> parameter’s value will be parsed as a
<a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc9651#name-tokens" id="ref-for-name-tokens①">token</a> representing a Reporting API <a data-link-type="dfn" href="https://w3c.github.io/reporting/#endpoint" id="ref-for-endpoint②">endpoint</a> <a data-link-type="biblio" href="#biblio-reporting" title="Reporting API">[REPORTING]</a>. All other
parameters will be ignored.</p>
   <h3 class="heading settled" data-level="3.1" id="parsing"><span class="secno">3.1. </span><span class="content">Parsing</span><a class="self-link" href="#parsing"></a></h3>
   <div class="algorithm" data-algorithm="parse a response’s Connection Allowlists">
    
To <dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-parse-a-responses-connection-allowlists">parse a response’s Connection Allowlists</dfn> given a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response" id="ref-for-concept-response①">response</a>
(<var>response</var>):


    <ol>
     <li data-md>
      <p>Let <var>allowlists</var> be an empty <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list①">list</a>.</p>
     <li data-md>
      <p>Let <var>header</var> be the result of <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-list-get-structured-header" id="ref-for-concept-header-list-get-structured-header">getting a structured field value</a> named
`<code><a data-link-type="http-header" href="#http-headerdef-connection-allowlist" id="ref-for-http-headerdef-connection-allowlist①">Connection-Allowlist</a></code>` as a <a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc9651#name-list" id="ref-for-name-list①">list</a> from <var>response</var>’s
<a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-header-list" id="ref-for-concept-response-header-list">header list</a>.</p>
     <li data-md>
      <p><a data-link-type="abstract-op" href="#abstract-opdef-parse-a-connection-allowlist-header" id="ref-for-abstract-opdef-parse-a-connection-allowlist-header">Parse a Connection Allowlist header</a> given <var>header</var>, <var>response</var>’s
<a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-url" id="ref-for-concept-response-url①">URL</a>, and <a data-link-type="grammar" href="#grammardef-connection-allowlist-disposition-enforce" id="ref-for-grammardef-connection-allowlist-disposition-enforce">enforce</a>. If the
result is not <code>null</code>, <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-insert" id="ref-for-list-insert">insert</a> it into <var>allowlists</var>.</p>
     <li data-md>
      <p>Let <var>header</var> be the result of <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-header-list-get-structured-header" id="ref-for-concept-header-list-get-structured-header①">getting a structured field value</a> named
`<code><a data-link-type="http-header" href="#http-headerdef-connection-allowlist-report-only" id="ref-for-http-headerdef-connection-allowlist-report-only">Connection-Allowlist-Report-Only</a></code>` as a <a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc9651#name-list" id="ref-for-name-list②">list</a> from <var>response</var>’s
<a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-header-list" id="ref-for-concept-response-header-list①">header list</a>.</p>
     <li data-md>
      <p><a data-link-type="abstract-op" href="#abstract-opdef-parse-a-connection-allowlist-header" id="ref-for-abstract-opdef-parse-a-connection-allowlist-header①">Parse a Connection Allowlist header</a> given <var>header</var>, <var>response</var>’s
<a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-response-url" id="ref-for-concept-response-url②">URL</a>, and <a data-link-type="grammar" href="#grammardef-connection-allowlist-disposition-report" id="ref-for-grammardef-connection-allowlist-disposition-report">report</a>. If the
result is not <code>null</code>, <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-insert" id="ref-for-list-insert①">insert</a> it into <var>allowlists</var>.</p>
     <li data-md>
      <p>Return <var>allowlists</var>.</p>
    </ol>
   </div>
   <div class="algorithm" data-algorithm="parse a Connection Allowlist header">
    
To <dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export data-local-lt="parse header" id="abstract-opdef-parse-a-connection-allowlist-header">parse a Connection Allowlist header</dfn> given a
<a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc9651#name-introduction" id="ref-for-name-introduction①">structured header</a> <a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc9651#name-list" id="ref-for-name-list③">list</a> (<var>list</var>), a <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url" id="ref-for-concept-url">URL</a> (<var>response-url</var>), and a
<a data-link-type="dfn" href="#connection-allowlist-disposition" id="ref-for-connection-allowlist-disposition">disposition</a> (<var>disposition</var>):


    <ol>
     <li data-md>
      <p>If <var>list</var>’s <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-size" id="ref-for-list-size">size</a> is 0, return <code>null</code>.</p>
     <li data-md>
      <p>If <var>list</var>[0] is not an <a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc9651#name-inner-list" id="ref-for-name-inner-list③">inner list</a>, return <code>null</code>.</p>
     <li data-md>
      <p>Let <var>allowlist</var> be a <a data-link-type="dfn" href="#connection-allowlist" id="ref-for-connection-allowlist">Connection Allowlist</a> whose <a data-link-type="dfn" href="#connection-allowlist-disposition" id="ref-for-connection-allowlist-disposition①">disposition</a> is
<var>disposition</var>.</p>
     <li data-md>
      <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate" id="ref-for-list-iterate">For each</a> <var>item</var> in <var>list</var>[0]:</p>
      <ol>
       <li data-md>
        <p>Let <var>serialized pattern</var> be <code>null</code>.</p>
       <li data-md>
        <p>If <var>item</var> is the <a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc9651#name-tokens" id="ref-for-name-tokens②">token</a> <a data-link-type="grammar" href="#grammardef-connection-allowlist-response-origin" id="ref-for-grammardef-connection-allowlist-response-origin"><code>response-origin</code></a>:</p>
        <ol>
         <li data-md>
          <p>Set <var>serialized pattern</var> to the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#ascii-serialisation-of-an-origin" id="ref-for-ascii-serialisation-of-an-origin">ASCII serialization</a>
of <var>response-url</var>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-origin" id="ref-for-concept-url-origin①">origin</a>.</p>
        </ol>
       <li data-md>
        <p>If <var>item</var> is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string" id="ref-for-string">string</a>, set <var>serialized pattern</var> to <var>item</var>.</p>
       <li data-md>
        <p>If <var>serialized pattern</var> is <code>null</code>, <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-continue" id="ref-for-iteration-continue">continue</a>.</p>
       <li data-md>
        <p>Let <var>URL pattern</var> be the result of executing <a data-link-type="dfn" href="https://urlpattern.spec.whatwg.org/#build-a-url-pattern-from-an-http-structured-field-value" id="ref-for-build-a-url-pattern-from-an-http-structured-field-value">build a URL pattern from an HTTP structured field value</a> given <var>serialized pattern</var> with <code>null</code> as the base URL.</p>
        <p>If this step throws an error, <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-continue" id="ref-for-iteration-continue①">continue</a>.</p>
       <li data-md>
        <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-append" id="ref-for-list-append">Append</a> <var>URL pattern</var> to <var>allowlist</var>’s <a data-link-type="dfn" href="#connection-allowlist-allowlist" id="ref-for-connection-allowlist-allowlist">allowlist</a>.</p>
      </ol>
     <li data-md>
      <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate" id="ref-for-list-iterate①">For each</a> <var>key</var> → <var>value</var> in <var>list</var>[0]'s <a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc9651#name-introduction" id="ref-for-name-introduction②">parameters</a>:</p>
      <ol>
       <li data-md>
        <p>If <var>key</var> is <a data-link-type="grammar" href="#grammardef-connection-allowlist-report-to" id="ref-for-grammardef-connection-allowlist-report-to"><code>report-to</code></a> and <var>value</var> is a
<a data-link-type="dfn" href="https://www.rfc-editor.org/rfc/rfc9651#name-tokens" id="ref-for-name-tokens③">token</a>, set <var>allowlist</var>’s <a data-link-type="dfn" href="#connection-allowlist-reporting-endpoint" id="ref-for-connection-allowlist-reporting-endpoint">reporting endpoint</a>
to <var>value</var>.</p>
      </ol>
     <li data-md>
      <p>Return <var>allowlist</var>.</p>
    </ol>
    <p class="note" role="note"><span class="marker">Note:</span> We’re skipping over any invalid input in the parsing algorithm. We could plausibly be more
draconian in our parsing, but that would likely limit our future flexibility.</p>
   </div>
   <h3 class="heading settled" data-level="3.2" id="matching"><span class="secno">3.2. </span><span class="content">Matching</span><a class="self-link" href="#matching"></a></h3>
   <p>Depending on the type of connection being established, we may have a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request">request</a> to work with, we
may only have a <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url" id="ref-for-concept-url①">URL</a>, or we may have even less. <a data-link-type="attr-value" href="https://html.spec.whatwg.org/multipage/links.html#link-type-dns-prefetch" id="ref-for-link-type-dns-prefetch"><code>dns-prefetch</code></a>,
for example, can only match against a host. The algorithms below spell out how connection allowlist
checks work in these scenarios:</p>
   <div class="algorithm" data-algorithm="match a URL to a Connection Allowlist">
    
To <dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export data-local-lt="matches" id="abstract-opdef-match-a-url-to-a-connection-allowlist">match a URL to a Connection Allowlist</dfn> given a <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url" id="ref-for-concept-url②">URL</a>
(<var>url</var>) and a <a data-link-type="dfn" href="#connection-allowlist" id="ref-for-connection-allowlist①">connection allowlist</a> (<var>connection allowlist</var>), execute the following steps,
which return <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#success" id="ref-for-success">success</a> or <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#failure" id="ref-for-failure">failure</a>.


    <ol>
     <li data-md>
      <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate" id="ref-for-list-iterate②">For each</a> <var>pattern</var> in <var>connection allowlist</var>’s
<a data-link-type="dfn" href="#connection-allowlist-allowlist" id="ref-for-connection-allowlist-allowlist①">allowlist</a>:</p>
      <ol>
       <li data-md>
        <p>If <a data-link-type="dfn" href="https://urlpattern.spec.whatwg.org/#url-pattern-match" id="ref-for-url-pattern-match">URL pattern matching</a> given <var>pattern</var> and <var>url</var> does not return
<code>null</code>, return <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#success" id="ref-for-success①">success</a>.</p>
      </ol>
     <li data-md>
      <p>Return <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#failure" id="ref-for-failure①">failure</a>.</p>
    </ol>
   </div>
   <div class="algorithm" data-algorithm="match a host to a Connection Allowlist">
    
To <dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export data-local-lt="match host" id="abstract-opdef-match-a-host-to-a-connection-allowlist">match a host to a Connection Allowlist</dfn> given a
<a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-host" id="ref-for-concept-host">host</a> (<var>host</var>) and a <a data-link-type="dfn" href="#connection-allowlist" id="ref-for-connection-allowlist②">connection allowlist</a> (<var>connection allowlist</var>), execute the following
steps, which return <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#success" id="ref-for-success②">success</a> or <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#failure" id="ref-for-failure②">failure</a>.


    <ol>
     <li data-md>
      <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate" id="ref-for-list-iterate③">For each</a> <var>pattern</var> in <var>connection allowlist</var>’s
<a data-link-type="dfn" href="#connection-allowlist-allowlist" id="ref-for-connection-allowlist-allowlist②">allowlist</a>:</p>
      <ol>
       <li data-md>
        <p>Let <var>input</var> be a new <code class="idl"><a data-link-type="idl" href="https://urlpattern.spec.whatwg.org/#dictdef-urlpatterninit" id="ref-for-dictdef-urlpatterninit">URLPatternInit</a></code> dictionary whose <code class="idl"><a data-link-type="idl" href="https://urlpattern.spec.whatwg.org/#dom-urlpatterninit-hostname" id="ref-for-dom-urlpatterninit-hostname">hostname</a></code> is
set to <var>pattern</var>’s <a data-link-type="dfn" href="https://urlpattern.spec.whatwg.org/#url-pattern-hostname-component" id="ref-for-url-pattern-hostname-component">hostname component</a>.</p>
       <li data-md>
        <p>Let <var>host-only pattern</var> be the result of <a data-link-type="dfn" href="https://urlpattern.spec.whatwg.org/#url-pattern-create" id="ref-for-url-pattern-create">creating a URL pattern</a> given
<var>input</var>, <code>null</code> as the base URL, and an empty <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ordered-map" id="ref-for-ordered-map">map</a> as the options.</p>
       <li data-md>
        <p>Let <var>synthetic url</var> be the result of <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-parser" id="ref-for-concept-url-parser">parsing</a> the concatenation of
"https://" and <var>host</var> as a URL.</p>
       <li data-md>
        <p>If <a data-link-type="dfn" href="https://urlpattern.spec.whatwg.org/#url-pattern-match" id="ref-for-url-pattern-match①">URL pattern matching</a> given <var>host-only pattern</var> and <var>synthetic url</var> does not
return <code>null</code>, return <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#success" id="ref-for-success③">success</a>.</p>
      </ol>
     <li data-md>
      <p>Return <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#failure" id="ref-for-failure③">failure</a>.</p>
    </ol>
    <p class="note" role="note"><span class="marker">Note:</span> By creating a new pattern with only the hostname component and synthesizing a URL for <var>host</var>,
we’re able to return a match if _any_ pattern in the allowlist could allow a request to that host
using any protocol, on any port, with any path, and so on.</p>
   </div>
   <div class="algorithm" data-algorithm="should url be blocked by Connection Allowlist">
    
The <dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-should-url-be-blocked-by-connection-allowlist">should <var>url</var> be blocked by Connection Allowlist</dfn> algorithm takes a
<a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url" id="ref-for-concept-url③">URL</a> (<var>url</var>), an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#environment" id="ref-for-environment">environment</a> (<var>environment</var>), and a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list②">list</a> of <a data-link-type="dfn" href="#policy-container-connection-allowlists" id="ref-for-policy-container-connection-allowlists">connection allowlists</a>
(<var>connection allowlists</var>). It returns either <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#allowed" id="ref-for-allowed">allowed</a> or <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#blocked" id="ref-for-blocked">blocked</a>:


    <ol>
     <li data-md>
      <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate" id="ref-for-list-iterate④">For each</a> <var>connection allowlist</var> in <var>connection allowlists</var>:</p>
      <ol>
       <li data-md>
        <p>If <var>url</var> <a data-link-type="abstract-op" href="#abstract-opdef-match-a-url-to-a-connection-allowlist" id="ref-for-abstract-opdef-match-a-url-to-a-connection-allowlist">matches</a> <var>connection allowlist</var>’s <a data-link-type="dfn" href="#connection-allowlist-allowlist" id="ref-for-connection-allowlist-allowlist③">allowlist</a>,
<a data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-continue" id="ref-for-iteration-continue②">continue</a>.</p>
       <li data-md>
        <p><a data-link-type="abstract-op" href="#abstract-opdef-report-a-violation" id="ref-for-abstract-opdef-report-a-violation">Report a violation</a> given <var>url</var>, <var>environment</var>, and
<var>connection allowlist</var>.</p>
       <li data-md>
        <p>If <var>connection allowlist</var>’s <a data-link-type="dfn" href="#connection-allowlist-disposition" id="ref-for-connection-allowlist-disposition②">disposition</a> is
<a data-link-type="grammar" href="#grammardef-connection-allowlist-disposition-enforce" id="ref-for-grammardef-connection-allowlist-disposition-enforce①">enforce</a>, return <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#blocked" id="ref-for-blocked①">blocked</a>.</p>
      </ol>
     <li data-md>
      <p>Return <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#allowed" id="ref-for-allowed①">allowed</a>.</p>
    </ol>
   </div>
   <div class="algorithm" data-algorithm="should request be blocked by Connection Allowlists">
    
The <dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-should-request-be-blocked-by-connection-allowlists">should <var>request</var> be blocked by Connection Allowlists</dfn> algorithm
takes a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request①">request</a> (<var>request</var>), and returns either <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#allowed" id="ref-for-allowed②">allowed</a> or <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#blocked" id="ref-for-blocked②">blocked</a>:


    <ol>
     <li data-md>
      <p>If <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request②">request</a>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-url-list" id="ref-for-concept-request-url-list">URL list</a>’s <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-size" id="ref-for-list-size①">size</a> is greater than 1, return <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#blocked" id="ref-for-blocked③">blocked</a>.</p>
      <p class="issue" id="issue-10cd8a62"><a class="self-link" href="#issue-10cd8a62"></a> See the open question below in <a href="#redirects">§ 5.1 Redirects</a>.</p>
     <li data-md>
      <p>Return the result of executing <a data-link-type="abstract-op" href="#abstract-opdef-should-url-be-blocked-by-connection-allowlist" id="ref-for-abstract-opdef-should-url-be-blocked-by-connection-allowlist">should url be blocked by Connection Allowlist</a> given
<var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-url" id="ref-for-concept-request-url">url</a>, <var>request</var>’s <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-client" id="ref-for-concept-request-client">client</a>, and <var>request</var>’s
<a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-policy-container" id="ref-for-concept-request-policy-container">policy container</a>’s <a data-link-type="dfn" href="#policy-container-connection-allowlists" id="ref-for-policy-container-connection-allowlists①">connection allowlists</a>.</p>
    </ol>
   </div>
   <div class="algorithm" data-algorithm="should host be blocked by Connection Allowlists">
    
The <dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export id="abstract-opdef-should-host-be-blocked-by-connection-allowlists">should <var>host</var> be blocked by Connection Allowlists</dfn> algorithm takes
a <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-host" id="ref-for-concept-host①">host</a> (<var>host</var>), an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#environment" id="ref-for-environment①">environment</a> (<var>environment</var>), and a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list③">list</a> of
<a data-link-type="dfn" href="#policy-container-connection-allowlists" id="ref-for-policy-container-connection-allowlists②">connection allowlists</a> (<var>connection allowlists</var>). It returns either <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#allowed" id="ref-for-allowed③">allowed</a> or <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#blocked" id="ref-for-blocked④">blocked</a>:


    <ol>
     <li data-md>
      <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-iterate" id="ref-for-list-iterate⑤">For each</a> <var>connection allowlist</var> in <var>connection allowlists</var>:</p>
      <ol>
       <li data-md>
        <p>If <var>host</var> <a data-link-type="abstract-op" href="#abstract-opdef-match-a-host-to-a-connection-allowlist" id="ref-for-abstract-opdef-match-a-host-to-a-connection-allowlist">host-matches</a> <var>connection allowlist</var>, <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-continue" id="ref-for-iteration-continue③">continue</a>.</p>
       <li data-md>
        <p><a data-link-type="abstract-op" href="#abstract-opdef-report-a-violation" id="ref-for-abstract-opdef-report-a-violation①">Report a violation</a> given <var>host</var>, <var>environment</var>, and
<var>connection allowlist</var>.</p>
       <li data-md>
        <p>If <var>connection allowlist</var>’s <a data-link-type="dfn" href="#connection-allowlist-disposition" id="ref-for-connection-allowlist-disposition③">disposition</a> is
<a data-link-type="grammar" href="#grammardef-connection-allowlist-disposition-enforce" id="ref-for-grammardef-connection-allowlist-disposition-enforce②">enforce</a>, return <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#blocked" id="ref-for-blocked⑤">blocked</a>.</p>
      </ol>
     <li data-md>
      <p>Return <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#allowed" id="ref-for-allowed④">allowed</a>.</p>
    </ol>
   </div>
   <h3 class="heading settled" data-level="3.3" id="reporting"><span class="secno">3.3. </span><span class="content">Reporting</span><a class="self-link" href="#reporting"></a></h3>
   <p>Like other policy mechanisms, Connection Allowlists will report each violation to a Reporting API
endpoint specified in the allowlist headers. Violations are represented by the following dictionary
type:</p>
<pre class="def highlight idl"><c- b>enum</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="enum" data-export id="enumdef-connectionallowlistdisposition"><code><c- g>ConnectionAllowlistDisposition</c-></code></dfn> { <dfn class="dfn-paneled idl-code" data-dfn-for="ConnectionAllowlistDisposition" data-dfn-type="enum-value" data-export id="dom-connectionallowlistdisposition-enforce"><code><c- s>"enforce"</c-></code></dfn>, <dfn class="dfn-paneled idl-code" data-dfn-for="ConnectionAllowlistDisposition" data-dfn-type="enum-value" data-export id="dom-connectionallowlistdisposition-report"><code><c- s>"report"</c-></code></dfn> };

<c- b>dictionary</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="dictionary" data-export id="dictdef-connectionallowlistviolationreport"><code><c- g>ConnectionAllowlistViolationReport</c-></code></dfn> : <a data-link-type="idl-name" href="https://w3c.github.io/reporting/#reportbody" id="ref-for-reportbody"><c- n>ReportBody</c-></a> {
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-USVString" id="ref-for-idl-USVString"><c- b>USVString</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="ConnectionAllowlistViolationReport" data-dfn-type="dict-member" data-export data-type="USVString" id="dom-connectionallowlistviolationreport-url"><code><c- g>url</c-></code></dfn>;
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-USVString" id="ref-for-idl-USVString①"><c- b>USVString</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="ConnectionAllowlistViolationReport" data-dfn-type="dict-member" data-export data-type="USVString" id="dom-connectionallowlistviolationreport-connection"><code><c- g>connection</c-></code></dfn>;
  <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#idl-sequence" id="ref-for-idl-sequence"><c- b>sequence</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString" id="ref-for-idl-DOMString"><c- b>DOMString</c-></a>> <dfn class="dfn-paneled idl-code" data-dfn-for="ConnectionAllowlistViolationReport" data-dfn-type="dict-member" data-export data-type="sequence<DOMString>" id="dom-connectionallowlistviolationreport-allowlist"><code><c- g>allowlist</c-></code></dfn>;
  <a data-link-type="idl-name" href="#enumdef-connectionallowlistdisposition" id="ref-for-enumdef-connectionallowlistdisposition"><c- n>ConnectionAllowlistDisposition</c-></a> <dfn class="dfn-paneled idl-code" data-dfn-for="ConnectionAllowlistViolationReport" data-dfn-type="dict-member" data-export data-type="ConnectionAllowlistDisposition" id="dom-connectionallowlistviolationreport-disposition"><code><c- g>disposition</c-></code></dfn>;
};
</pre>
   <p><code class="idl"><a data-link-type="idl" href="#dictdef-connectionallowlistviolationreport" id="ref-for-dictdef-connectionallowlistviolationreport">ConnectionAllowlistViolationReport</a></code>’s <code class="idl"><a data-link-type="idl" href="#dom-connectionallowlistviolationreport-connection" id="ref-for-dom-connectionallowlistviolationreport-connection">connection</a></code> is the
serialized <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url" id="ref-for-concept-url④">URL</a> of the connection which violated the allowlist.</p>
   <p><code class="idl"><a data-link-type="idl" href="#dictdef-connectionallowlistviolationreport" id="ref-for-dictdef-connectionallowlistviolationreport①">ConnectionAllowlistViolationReport</a></code>’s <code class="idl"><a data-link-type="idl" href="#dom-connectionallowlistviolationreport-allowlist" id="ref-for-dom-connectionallowlistviolationreport-allowlist">allowlist</a></code> is the
<a data-link-type="dfn" href="#connection-allowlist-allowlist" id="ref-for-connection-allowlist-allowlist④">allowlist</a> which was violated.</p>
   <p><code class="idl"><a data-link-type="idl" href="#dictdef-connectionallowlistviolationreport" id="ref-for-dictdef-connectionallowlistviolationreport②">ConnectionAllowlistViolationReport</a></code>’s <code class="idl"><a data-link-type="idl" href="#dom-connectionallowlistviolationreport-disposition" id="ref-for-dom-connectionallowlistviolationreport-disposition">disposition</a></code>
is the <code class="idl"><a data-link-type="idl" href="#dom-connectionallowlistviolationreport-allowlist" id="ref-for-dom-connectionallowlistviolationreport-allowlist①">allowlist</a></code>’s <a data-link-type="dfn" href="#connection-allowlist-disposition" id="ref-for-connection-allowlist-disposition④">disposition</a>.</p>
   <div class="algorithm" data-algorithm="report a violation">
    
To <dfn class="dfn-paneled" data-dfn-type="abstract-op" data-export data-local-lt="report" id="abstract-opdef-report-a-violation">report a violation</dfn> given a <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url" id="ref-for-concept-url⑤">URL</a> (<var>resource URL</var>),
an <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/webappapis.html#environment" id="ref-for-environment②">environment</a> (<var>environment</var>), and a <a data-link-type="dfn" href="#connection-allowlist" id="ref-for-connection-allowlist③">connection allowlist</a> (<var>allowlist</var>):


    <ol>
     <li data-md>
      <p>If <var>allowlist</var>’s <a data-link-type="dfn" href="#connection-allowlist-reporting-endpoint" id="ref-for-connection-allowlist-reporting-endpoint①">reporting endpoint</a> is <code>null</code>, return.</p>
     <li data-md>
      <p>Let <var>violation</var> be a new <code class="idl"><a data-link-type="idl" href="#dictdef-connectionallowlistviolationreport" id="ref-for-dictdef-connectionallowlistviolationreport③">ConnectionAllowlistViolationReport</a></code>, initialized as follows:</p>
    </ol>
    <dl>
     <dt data-md><code class="idl"><a data-link-type="idl" href="#dom-connectionallowlistviolationreport-connection" id="ref-for-dom-connectionallowlistviolationreport-connection①">connection</a></code>
     <dd data-md>
      <p><var>resource URL</var>, <a data-link-type="dfn" href="https://w3c.github.io/reporting/#strip-url-for-use-in-reports" id="ref-for-strip-url-for-use-in-reports">stripped for use in reports</a>.</p>
      <p class="note" role="note"><span class="marker">Note:</span> Because we block redirects, we don’t need to worry about <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-url" id="ref-for-concept-request-url①">url</a> vs
  <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-current-url" id="ref-for-concept-request-current-url">current url</a>. When we go back on that decision (see <a href="#redirects">§ 5.1 Redirects</a>), we’ll want
  to ensure we use <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request-url" id="ref-for-concept-request-url②">url</a> to avoid leaking more information than necessary about
  redirect targets.</p>
     <dt data-md><code class="idl"><a data-link-type="idl" href="#dom-connectionallowlistviolationreport-allowlist" id="ref-for-dom-connectionallowlistviolationreport-allowlist②">allowlist</a></code>
     <dd data-md>
      <p><var>allowlist</var>’s <a data-link-type="dfn" href="#connection-allowlist-allowlist" id="ref-for-connection-allowlist-allowlist⑤">allowlist</a></p>
     <dt data-md><code class="idl"><a data-link-type="idl" href="#dom-connectionallowlistviolationreport-disposition" id="ref-for-dom-connectionallowlistviolationreport-disposition①">disposition</a></code>
     <dd data-md>
      <p><var>allowlist</var>’s <a data-link-type="dfn" href="#connection-allowlist-disposition" id="ref-for-connection-allowlist-disposition⑤">disposition</a>.</p>
    </dl>
    <ol start="3">
     <li data-md>
      <p><a data-link-type="dfn" href="https://w3c.github.io/reporting/#generate-and-queue-a-report" id="ref-for-generate-and-queue-a-report">Generate and queue a report</a> given <var>environment</var> as the context, "<code>connection-allowlist</code>" as
the type, <var>allowlist</var>’s <a data-link-type="dfn" href="#connection-allowlist-reporting-endpoint" id="ref-for-connection-allowlist-reporting-endpoint②">reporting endpoint</a> as the destination, and
<var>violation</var> as the data.</p>
    </ol>
   </div>
   <h2 class="heading settled" data-level="4" id="monkey-patching"><span class="secno">4. </span><span class="content">Monkey-Patches</span><a class="self-link" href="#monkey-patching"></a></h2>
   <h3 class="heading settled" data-level="4.1" id="fetch"><span class="secno">4.1. </span><span class="content">Integration with Fetch</span><a class="self-link" href="#fetch"></a></h3>
   <p>We’ll handle <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request③">requests</a> by adding a blocking check in <a href="https://fetch.spec.whatwg.org/#main-fetch"><cite>Fetch</cite> § 4.1 Main fetch</a> alongside other checks
that serve the same purpose:</p>
   <div class="algorithm" data-algorithm="monkey patching main fetch">
    
  In Main Fetch, we’ll adjust step 7 as follows:

  
    <ol start="7">
     <li data-md>
      <p>
       If should request be blocked due to a bad port, should fetching request be blocked as mixed
content, should request be blocked by Content Security Policy, 
       <ins><a data-link-type="abstract-op" href="#abstract-opdef-should-request-be-blocked-by-connection-allowlists" id="ref-for-abstract-opdef-should-request-be-blocked-by-connection-allowlists">should request be blocked by Connection Allowlists</a>, </ins>
       or should request be blocked by Integrity Policy
Policy returns blocked, then set response to a network error.
      </p>
    </ol>
   </div>
   <p>Fetch also defines algorithms at a lower level which are used to establish connections for APIs
which aren’t based on <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request④">requests</a>. We’ll hook into <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#resolve-an-origin" id="ref-for-resolve-an-origin">resolve an origin</a> and <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-connection-obtain" id="ref-for-concept-connection-obtain">obtain a connection</a> to handle things like DNS prefetch, Web Transport, etc:</p>
   <div class="algorithm" data-algorithm="monkey patching resolve an origin">
    
  In <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#resolve-an-origin" id="ref-for-resolve-an-origin①">resolve an origin</a>, we’ll call out to the host-only matching algorithm above to determine
  whether any pattern could potentially allow a connection to a given host. If not, we’ll fail
  resolution.


    <ol>
     <li data-md>
      <ins>If <a data-link-type="abstract-op" href="#abstract-opdef-should-host-be-blocked-by-connection-allowlists" id="ref-for-abstract-opdef-should-host-be-blocked-by-connection-allowlists">should host be blocked by Connection Allowlists</a> returns <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#blocked" id="ref-for-blocked⑥">blocked</a> when executed
 upon <var>origin</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host" id="ref-for-concept-origin-host">host</a>, <var>allowlist</var>, and <var>environment</var>, return
 <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#failure" id="ref-for-failure④">failure</a>.</ins>
    </ol>
    <p class="issue" id="issue-f6aa86e5"><a class="self-link" href="#issue-f6aa86e5"></a> This will require us to pass additional information into this algorithm’s callsites
  to identify the allowlist which ought to be used (<var>allowlist</var>, <var>environment</var>).</p>
   </div>
   <div class="algorithm" data-algorithm="monkey patching obtain a connection">
    
  In <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-connection-obtain" id="ref-for-concept-connection-obtain①">obtain a connection</a>, we’ll add a check before the current step 2:

  
    <ol start="2">
     <li data-md>
      <ins>If <var>url</var></ins>
       <var>allowlist</var> <var>environment</var>

    </ol>
    <p class="issue" id="issue-f6aa86e5①"><a class="self-link" href="#issue-f6aa86e5①"></a> This will require us to pass additional information into this algorithm’s callsites
  to identify the allowlist which ought to be used (<var>allowlist</var>, <var>environment</var>).</p>
   </div>
   <h3 class="heading settled" data-level="4.2" id="html"><span class="secno">4.2. </span><span class="content">Integration with HTML</span><a class="self-link" href="#html"></a></h3>
   <p>To integrate the above into HTML, we’ll add a new
<dfn class="dfn-paneled" data-dfn-for="policy container" data-dfn-type="dfn" data-noexport id="policy-container-connection-allowlists">connection allowlists</dfn> item to the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#policy-container" id="ref-for-policy-container①">policy container</a>
<a data-link-type="dfn" href="https://infra.spec.whatwg.org/#struct" id="ref-for-struct①">struct</a>, containing a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list④">list</a> of <a data-link-type="dfn" href="#policy-container-connection-allowlists" id="ref-for-policy-container-connection-allowlists③">connection allowlists</a>. This will be populated by adding a
step to the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#creating-a-policy-container-from-a-fetch-response" id="ref-for-creating-a-policy-container-from-a-fetch-response">create a policy container from a fetch response</a> algorithm:</p>
   <div class="algorithm" data-algorithm="monkey patching policy container creation">
    <ol start="6">
     <li data-md>
      <p>Parse Integrity-Policy headers with <var>response</var> and <var>result</var>.</p>
     <li data-md>
      <ins>Set <var>result</var>’s <a data-link-type="dfn" href="#policy-container-connection-allowlists" id="ref-for-policy-container-connection-allowlists④">connection allowlists</a> to the result of
<a data-link-type="abstract-op" href="#abstract-opdef-parse-a-responses-connection-allowlists" id="ref-for-abstract-opdef-parse-a-responses-connection-allowlists">parsing a response’s Connection Allowlists</a> given
<var>response</var>.</ins>
     <li data-md>
      <p>Return <var>result</var>.</p>
    </ol>
   </div>
   <h2 class="heading settled" data-level="5" id="questions"><span class="secno">5. </span><span class="content">Open Questions</span><a class="self-link" href="#questions"></a></h2>
   <h3 class="heading settled" data-level="5.1" id="redirects"><span class="secno">5.1. </span><span class="content">Redirects</span><a class="self-link" href="#redirects"></a></h3>
   <p>Currently, we specify that any redirected URL fails. This simplifies the initial proposal for
discussion, but seems unlikely to satisfy developers with real-world deployment needs. I think we
have a few realistic options:</p>
   <ol>
    <li data-md>
     <p>Apply the allowlist to every hop of a redirect chain. This has the advantage of matching CSP’s
behavior that developers are already familiar with. It _is_ a cross-origin data leak insofar as it
provides insight about another origin’s decisions, which is unfortunate but perhaps unavoidable.</p>
    <li data-md>
     <p>Allow _a specific rule_’s redirect chain to arbitrarily redirect. This narrows the concerns
above by forcing developers to annotate the allowlist with their expectations. It might be perfectly
acceptable for <code>https://trusted.example/</code> to redirect users to arbitrary locations, while other
endpoints are expected to remain put. Annotating list items should make this kind of distinction
possible if necessary (e.g. <code>("https://trusted.example/";redirection-allowed "https://less-so.example/")</code>).</p>
    <li data-md>
     <p>Narrow the above by allowing _a specific rule_ to redirect so long as the targets match the allowlist.
This creates less opportunity for unexpected connection than 1 or 2 by requiring developers to annotate
the specific rules which can redirect, but would do so in a way that’s less broad (e.g.
<code>("https://semi-trusted.example/";redirection-allowed=within-allowlist ...)</code>).</p>
   </ol>
   <p>We could add more options as well. CSP’s earlier <code>navigate-to</code> proposal distinguished between intermediate
redirects and the final, non-redirect response. You could imagine adding those kinds of options either to
the entire allowlist or individual rules. Feedback here as well would be much appreciated.</p>
  </main>
  <div data-fill-with="conformance">
   <h2 class="heading no-num no-ref settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="heading no-num no-ref settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification.

    </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a>

    </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this:

    </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a>
        
    <p>This is an example of an informative example.
    </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this:

    </p>
   <p class="note" role="note">Note, this is an informative note.</p>
  </div>
  <script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="heading no-num no-ref settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="heading no-num no-ref settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li>
    allowlist
    <ul>
     <li><a href="#connection-allowlist-allowlist">dfn for Connection Allowlist</a><span>, in § 2</span>
     <li><a href="#dom-connectionallowlistviolationreport-allowlist">dict-member for ConnectionAllowlistViolationReport</a><span>, in § 3.3</span>
    </ul>
   <li><a href="#dom-connectionallowlistviolationreport-connection">connection</a><span>, in § 3.3</span>
   <li><a href="#connection-allowlist">Connection Allowlist</a><span>, in § 2</span>
   <li><a href="#http-headerdef-connection-allowlist">Connection-Allowlist</a><span>, in § 3</span>
   <li><a href="#enumdef-connectionallowlistdisposition">ConnectionAllowlistDisposition</a><span>, in § 3.3</span>
   <li><a href="#http-headerdef-connection-allowlist-report-only">Connection-Allowlist-Report-Only</a><span>, in § 3</span>
   <li><a href="#policy-container-connection-allowlists">connection allowlists</a><span>, in § 4.2</span>
   <li><a href="#dictdef-connectionallowlistviolationreport">ConnectionAllowlistViolationReport</a><span>, in § 3.3</span>
   <li>
    disposition
    <ul>
     <li><a href="#connection-allowlist-disposition">dfn for Connection Allowlist</a><span>, in § 2</span>
     <li><a href="#dom-connectionallowlistviolationreport-disposition">dict-member for ConnectionAllowlistViolationReport</a><span>, in § 3.3</span>
    </ul>
   <li><a href="#dom-connectionallowlistdisposition-enforce">"enforce"</a><span>, in § 3.3</span>
   <li><a href="#grammardef-connection-allowlist-disposition-enforce">enforce</a><span>, in § 2</span>
   <li><a href="#abstract-opdef-match-a-host-to-a-connection-allowlist">match a host to a Connection Allowlist</a><span>, in § 3.2</span>
   <li><a href="#abstract-opdef-match-a-url-to-a-connection-allowlist">match a URL to a Connection Allowlist</a><span>, in § 3.2</span>
   <li><a href="#abstract-opdef-match-a-url-to-a-connection-allowlist">matches</a><span>, in § 3.2</span>
   <li><a href="#abstract-opdef-match-a-host-to-a-connection-allowlist">match host</a><span>, in § 3.2</span>
   <li><a href="#abstract-opdef-parse-a-connection-allowlist-header">parse a Connection Allowlist header</a><span>, in § 3.1</span>
   <li><a href="#abstract-opdef-parse-a-responses-connection-allowlists">parse a response’s Connection Allowlists</a><span>, in § 3.1</span>
   <li><a href="#abstract-opdef-parse-a-connection-allowlist-header">parse header</a><span>, in § 3.1</span>
   <li><a href="#dom-connectionallowlistdisposition-report">"report"</a><span>, in § 3.3</span>
   <li>
    report
    <ul>
     <li><a href="#abstract-opdef-report-a-violation">(abstract-op)</a><span>, in § 3.3</span>
     <li><a href="#grammardef-connection-allowlist-disposition-report">grammar for Connection Allowlist/disposition</a><span>, in § 2</span>
    </ul>
   <li><a href="#abstract-opdef-report-a-violation">report a violation</a><span>, in § 3.3</span>
   <li><a href="#connection-allowlist-reporting-endpoint">reporting endpoint</a><span>, in § 2</span>
   <li><a href="#grammardef-connection-allowlist-report-to">report-to</a><span>, in § 3</span>
   <li><a href="#grammardef-connection-allowlist-response-origin">response-origin</a><span>, in § 3</span>
   <li><a href="#abstract-opdef-should-host-be-blocked-by-connection-allowlists">should host be blocked by Connection Allowlists</a><span>, in § 3.2</span>
   <li><a href="#abstract-opdef-should-request-be-blocked-by-connection-allowlists">should request be blocked by Connection Allowlists</a><span>, in § 3.2</span>
   <li><a href="#abstract-opdef-should-url-be-blocked-by-connection-allowlist">should url be blocked by Connection Allowlist</a><span>, in § 3.2</span>
   <li><a href="#dom-connectionallowlistviolationreport-url">url</a><span>, in § 3.3</span>
  </ul>
  <h3 class="heading no-num no-ref settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[CSP]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="9b40f5cd">fetch directives</span>
     <li><span class="dfn-paneled" id="0950067d">host-source</span>
    </ul>
   <li>
    <a data-link-type="biblio">[FETCH]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="857d5516">client</span>
     <li><span class="dfn-paneled" id="3f2ca4de">current URL</span>
     <li><span class="dfn-paneled" id="2ce6f6bb">fetch(input)</span>
     <li><span class="dfn-paneled" id="5c66de35">get a structured field value</span>
     <li><span class="dfn-paneled" id="c9e7c11a">header</span>
     <li><span class="dfn-paneled" id="f7b00a8b">header list</span>
     <li><span class="dfn-paneled" id="8e1fb11c">obtain a connection</span>
     <li><span class="dfn-paneled" id="86efadaf">policy container</span>
     <li><span class="dfn-paneled" id="55213b5b">request</span>
     <li><span class="dfn-paneled" id="61c338be">resolve an origin</span>
     <li><span class="dfn-paneled" id="ee7bba09">response</span>
     <li><span class="dfn-paneled" id="dc1cd39b">URL <small>(for request)</small></span>
     <li><span class="dfn-paneled" id="3268a8eb">URL <small>(for response)</small></span>
     <li><span class="dfn-paneled" id="ae56d57e">URL list</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="b410a6ef">ASCII serialization of an origin</span>
     <li><span class="dfn-paneled" id="cfb6031b">creating a policy container from a fetch response</span>
     <li><span class="dfn-paneled" id="1abc08f1">dns-prefetch</span>
     <li><span class="dfn-paneled" id="24cf98a1">environment</span>
     <li><span class="dfn-paneled" id="77a2ee6e">host</span>
     <li><span class="dfn-paneled" id="b33787b2">policy container</span>
    </ul>
   <li>
    <a data-link-type="biblio">[INFRA]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="daf5c14d">allowed</span>
     <li><span class="dfn-paneled" id="53275e46">append</span>
     <li><span class="dfn-paneled" id="83af367f">blocked</span>
     <li><span class="dfn-paneled" id="f937b7b6">continue</span>
     <li><span class="dfn-paneled" id="bf8d9616">failure</span>
     <li><span class="dfn-paneled" id="56ad2aed">insert</span>
     <li><span class="dfn-paneled" id="c88f3887">item</span>
     <li><span class="dfn-paneled" id="f02cd417">iterate</span>
     <li><span class="dfn-paneled" id="649608b9">list</span>
     <li><span class="dfn-paneled" id="3fca5a9e">map</span>
     <li><span class="dfn-paneled" id="0204d188">size</span>
     <li><span class="dfn-paneled" id="0698d556">string</span>
     <li><span class="dfn-paneled" id="984221ca">struct</span>
     <li><span class="dfn-paneled" id="98b32dd9">success</span>
    </ul>
   <li>
    <a data-link-type="biblio">[REPORTING]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="188c6617">ReportBody</span>
     <li><span class="dfn-paneled" id="9239678f">endpoint</span>
     <li><span class="dfn-paneled" id="7ed9d314">generate and queue a report</span>
     <li><span class="dfn-paneled" id="cfe36e16">Reporting-Endpoints</span>
     <li><span class="dfn-paneled" id="093a0772">strip URL for use in reports</span>
    </ul>
   <li>
    <a data-link-type="biblio">[RFC9651]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="5946b9a9">inner list</span>
     <li><span class="dfn-paneled" id="a7b0745e">list</span>
     <li><span class="dfn-paneled" id="7660bec4">parameters</span>
     <li><span class="dfn-paneled" id="c9aec5e7">string</span>
     <li><span class="dfn-paneled" id="de2211fe">structured header</span>
     <li><span class="dfn-paneled" id="4acd57ce">token</span>
    </ul>
   <li>
    <a data-link-type="biblio">[URL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="752d140b">host</span>
     <li><span class="dfn-paneled" id="959ad97b">origin</span>
     <li><span class="dfn-paneled" id="dcffbccd">URL</span>
     <li><span class="dfn-paneled" id="ca3ca4ae">URL parser</span>
    </ul>
   <li>
    <a data-link-type="biblio">[URLPATTERN]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="90f4193a">URLPatternInit</span>
     <li><span class="dfn-paneled" id="9a15e8d7">build a URL pattern from an HTTP structured field value</span>
     <li><span class="dfn-paneled" id="bf9f0d4e">create</span>
     <li><span class="dfn-paneled" id="d762bbef">hostname</span>
     <li><span class="dfn-paneled" id="45d80b74">hostname component</span>
     <li><span class="dfn-paneled" id="5c4f772b">match</span>
     <li><span class="dfn-paneled" id="60393e82">URL pattern</span>
    </ul>
   <li>
    <a data-link-type="biblio">[WEBIDL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="8855a9aa">DOMString</span>
     <li><span class="dfn-paneled" id="b0d7f3c3">USVString</span>
     <li><span class="dfn-paneled" id="9cce47fd">sequence</span>
    </ul>
   <li>
    <a data-link-type="biblio">[XHR]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="d06b2b8c">XMLHttpRequest</span>
    </ul>
  </ul>
  <h2 class="heading no-num no-ref settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="heading no-num no-ref settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-csp">[CSP]
   <dd>Mike West; Antonio Sartori. <a href="https://w3c.github.io/webappsec-csp/"><cite>Content Security Policy Level 3</cite></a>. URL: <a href="https://w3c.github.io/webappsec-csp/">https://w3c.github.io/webappsec-csp/</a>
   <dt id="biblio-fetch">[FETCH]
   <dd>Anne van Kesteren. <a href="https://fetch.spec.whatwg.org/"><cite>Fetch Standard</cite></a>. Living Standard. URL: <a href="https://fetch.spec.whatwg.org/">https://fetch.spec.whatwg.org/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-infra">[INFRA]
   <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/"><cite>Infra Standard</cite></a>. Living Standard. URL: <a href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
   <dt id="biblio-reporting">[REPORTING]
   <dd>Douglas Creager; Ian Clelland; Mike West. <a href="https://w3c.github.io/reporting/"><cite>Reporting API</cite></a>. URL: <a href="https://w3c.github.io/reporting/">https://w3c.github.io/reporting/</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-rfc9651">[RFC9651]
   <dd>M. Nottingham; P-H. Kamp. <a href="https://www.rfc-editor.org/rfc/rfc9651"><cite>Structured Field Values for HTTP</cite></a>. September 2024. Proposed Standard. URL: <a href="https://www.rfc-editor.org/rfc/rfc9651">https://www.rfc-editor.org/rfc/rfc9651</a>
   <dt id="biblio-url">[URL]
   <dd>Anne van Kesteren. <a href="https://url.spec.whatwg.org/"><cite>URL Standard</cite></a>. Living Standard. URL: <a href="https://url.spec.whatwg.org/">https://url.spec.whatwg.org/</a>
   <dt id="biblio-urlpattern">[URLPATTERN]
   <dd>Ben Kelly; Jeremy Roman; 宍戸俊哉 (Shunya Shishido). <a href="https://urlpattern.spec.whatwg.org/"><cite>URL Pattern Standard</cite></a>. Living Standard. URL: <a href="https://urlpattern.spec.whatwg.org/">https://urlpattern.spec.whatwg.org/</a>
   <dt id="biblio-webidl">[WEBIDL]
   <dd>Edgar Chen; Timothy Gu. <a href="https://webidl.spec.whatwg.org/"><cite>Web IDL Standard</cite></a>. Living Standard. URL: <a href="https://webidl.spec.whatwg.org/">https://webidl.spec.whatwg.org/</a>
   <dt id="biblio-xhr">[XHR]
   <dd>Anne van Kesteren. <a href="https://xhr.spec.whatwg.org/"><cite>XMLHttpRequest Standard</cite></a>. Living Standard. URL: <a href="https://xhr.spec.whatwg.org/">https://xhr.spec.whatwg.org/</a>
  </dl>
  <h2 class="heading no-num no-ref settled" id="idl-index"><span class="content">IDL Index</span><a class="self-link" href="#idl-index"></a></h2>
<pre class="def highlight idl"><c- b>enum</c-> <a href="#enumdef-connectionallowlistdisposition"><code><c- g>ConnectionAllowlistDisposition</c-></code></a> { <a href="#dom-connectionallowlistdisposition-enforce"><code><c- s>"enforce"</c-></code></a>, <a href="#dom-connectionallowlistdisposition-report"><code><c- s>"report"</c-></code></a> };

<c- b>dictionary</c-> <a href="#dictdef-connectionallowlistviolationreport"><code><c- g>ConnectionAllowlistViolationReport</c-></code></a> : <a data-link-type="idl-name" href="https://w3c.github.io/reporting/#reportbody"><c- n>ReportBody</c-></a> {
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-USVString"><c- b>USVString</c-></a> <a data-type="USVString" href="#dom-connectionallowlistviolationreport-url"><code><c- g>url</c-></code></a>;
  <a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-USVString"><c- b>USVString</c-></a> <a data-type="USVString" href="#dom-connectionallowlistviolationreport-connection"><code><c- g>connection</c-></code></a>;
  <a data-link-type="dfn" href="https://webidl.spec.whatwg.org/#idl-sequence"><c- b>sequence</c-></a>&lt;<a class="idl-code" data-link-type="interface" href="https://webidl.spec.whatwg.org/#idl-DOMString"><c- b>DOMString</c-></a>> <a data-type="sequence<DOMString>" href="#dom-connectionallowlistviolationreport-allowlist"><code><c- g>allowlist</c-></code></a>;
  <a data-link-type="idl-name" href="#enumdef-connectionallowlistdisposition"><c- n>ConnectionAllowlistDisposition</c-></a> <a data-type="ConnectionAllowlistDisposition" href="#dom-connectionallowlistviolationreport-disposition"><code><c- g>disposition</c-></code></a>;
};

</pre>
  <h2 class="heading no-num no-ref settled" id="issues-index"><span class="content">Issues Index</span><a class="self-link" href="#issues-index"></a></h2>
  <div style="counter-reset:issue">
   <div class="issue"> See the open question below in <a href="#redirects">§ 5.1 Redirects</a>. <a class="issue-return" href="#issue-10cd8a62" title="Jump to section">↵</a></div>
   <div class="issue"> This will require us to pass additional information into this algorithm’s callsites
  to identify the allowlist which ought to be used (<var>allowlist</var>, <var>environment</var>). <a class="issue-return" href="#issue-f6aa86e5" title="Jump to section">↵</a></div>
   <div class="issue"> This will require us to pass additional information into this algorithm’s callsites
  to identify the allowlist which ought to be used (<var>allowlist</var>, <var>environment</var>). <a class="issue-return" href="#issue-f6aa86e5①" title="Jump to section">↵</a></div>
  </div>
<script>/* Boilerplate: script-dom-helper */
"use strict";
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
let dfnPanelData = {
"0204d188": {"dfnID":"0204d188","dfnText":"size","external":true,"refSections":[{"refs":[{"id":"ref-for-list-size"}],"title":"3.1. Parsing"},{"refs":[{"id":"ref-for-list-size\u2460"}],"title":"3.2. Matching"}],"url":"https://infra.spec.whatwg.org/#list-size"},
"0698d556": {"dfnID":"0698d556","dfnText":"string","external":true,"refSections":[{"refs":[{"id":"ref-for-string"}],"title":"3.1. Parsing"}],"url":"https://infra.spec.whatwg.org/#string"},
"093a0772": {"dfnID":"093a0772","dfnText":"strip URL for use in reports","external":true,"refSections":[{"refs":[{"id":"ref-for-strip-url-for-use-in-reports"}],"title":"3.3. Reporting"}],"url":"https://w3c.github.io/reporting/#strip-url-for-use-in-reports"},
"0950067d": {"dfnID":"0950067d","dfnText":"host-source","external":true,"refSections":[{"refs":[{"id":"ref-for-grammardef-host-source"}],"title":"1.2. Overlap with Content Security Policy"}],"url":"https://w3c.github.io/webappsec-csp/#grammardef-host-source"},
"188c6617": {"dfnID":"188c6617","dfnText":"ReportBody","external":true,"refSections":[{"refs":[{"id":"ref-for-reportbody"}],"title":"3.3. Reporting"}],"url":"https://w3c.github.io/reporting/#reportbody"},
"1abc08f1": {"dfnID":"1abc08f1","dfnText":"dns-prefetch","external":true,"refSections":[{"refs":[{"id":"ref-for-link-type-dns-prefetch"}],"title":"3.2. Matching"}],"url":"https://html.spec.whatwg.org/multipage/links.html#link-type-dns-prefetch"},
"24cf98a1": {"dfnID":"24cf98a1","dfnText":"environment","external":true,"refSections":[{"refs":[{"id":"ref-for-environment"},{"id":"ref-for-environment\u2460"}],"title":"3.2. Matching"},{"refs":[{"id":"ref-for-environment\u2461"}],"title":"3.3. Reporting"}],"url":"https://html.spec.whatwg.org/multipage/webappapis.html#environment"},
"2ce6f6bb": {"dfnID":"2ce6f6bb","dfnText":"fetch(input)","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-global-fetch"}],"title":"1.1. Threat Model"}],"url":"https://fetch.spec.whatwg.org/#dom-global-fetch"},
"3268a8eb": {"dfnID":"3268a8eb","dfnText":"URL (for response)","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-response-url"}],"title":"3. Connection Allowlist Headers"},{"refs":[{"id":"ref-for-concept-response-url\u2460"},{"id":"ref-for-concept-response-url\u2461"}],"title":"3.1. Parsing"}],"url":"https://fetch.spec.whatwg.org/#concept-response-url"},
"3f2ca4de": {"dfnID":"3f2ca4de","dfnText":"current URL","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-current-url"}],"title":"3.3. Reporting"}],"url":"https://fetch.spec.whatwg.org/#concept-request-current-url"},
"3fca5a9e": {"dfnID":"3fca5a9e","dfnText":"map","external":true,"refSections":[{"refs":[{"id":"ref-for-ordered-map"}],"title":"3.2. Matching"}],"url":"https://infra.spec.whatwg.org/#ordered-map"},
"45d80b74": {"dfnID":"45d80b74","dfnText":"hostname component","external":true,"refSections":[{"refs":[{"id":"ref-for-url-pattern-hostname-component"}],"title":"3.2. Matching"}],"url":"https://urlpattern.spec.whatwg.org/#url-pattern-hostname-component"},
"4acd57ce": {"dfnID":"4acd57ce","dfnText":"token","external":true,"refSections":[{"refs":[{"id":"ref-for-name-tokens"},{"id":"ref-for-name-tokens\u2460"}],"title":"3. Connection Allowlist Headers"},{"refs":[{"id":"ref-for-name-tokens\u2461"},{"id":"ref-for-name-tokens\u2462"}],"title":"3.1. Parsing"}],"url":"https://www.rfc-editor.org/rfc/rfc9651#name-tokens"},
"53275e46": {"dfnID":"53275e46","dfnText":"append","external":true,"refSections":[{"refs":[{"id":"ref-for-list-append"}],"title":"3.1. Parsing"}],"url":"https://infra.spec.whatwg.org/#list-append"},
"55213b5b": {"dfnID":"55213b5b","dfnText":"request","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request"},{"id":"ref-for-concept-request\u2460"},{"id":"ref-for-concept-request\u2461"}],"title":"3.2. Matching"},{"refs":[{"id":"ref-for-concept-request\u2462"},{"id":"ref-for-concept-request\u2463"}],"title":"4.1. Integration with Fetch"}],"url":"https://fetch.spec.whatwg.org/#concept-request"},
"56ad2aed": {"dfnID":"56ad2aed","dfnText":"insert","external":true,"refSections":[{"refs":[{"id":"ref-for-list-insert"},{"id":"ref-for-list-insert\u2460"}],"title":"3.1. Parsing"}],"url":"https://infra.spec.whatwg.org/#list-insert"},
"5946b9a9": {"dfnID":"5946b9a9","dfnText":"inner list","external":true,"refSections":[{"refs":[{"id":"ref-for-name-inner-list"},{"id":"ref-for-name-inner-list\u2460"},{"id":"ref-for-name-inner-list\u2461"}],"title":"3. Connection Allowlist Headers"},{"refs":[{"id":"ref-for-name-inner-list\u2462"}],"title":"3.1. Parsing"}],"url":"https://www.rfc-editor.org/rfc/rfc9651#name-inner-list"},
"5c4f772b": {"dfnID":"5c4f772b","dfnText":"match","external":true,"refSections":[{"refs":[{"id":"ref-for-url-pattern-match"},{"id":"ref-for-url-pattern-match\u2460"}],"title":"3.2. Matching"}],"url":"https://urlpattern.spec.whatwg.org/#url-pattern-match"},
"5c66de35": {"dfnID":"5c66de35","dfnText":"get a structured field value","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-header-list-get-structured-header"},{"id":"ref-for-concept-header-list-get-structured-header\u2460"}],"title":"3.1. Parsing"}],"url":"https://fetch.spec.whatwg.org/#concept-header-list-get-structured-header"},
"60393e82": {"dfnID":"60393e82","dfnText":"URL pattern","external":true,"refSections":[{"refs":[{"id":"ref-for-url-pattern"},{"id":"ref-for-url-pattern\u2460"}],"title":"2. Connection Allowlists"}],"url":"https://urlpattern.spec.whatwg.org/#url-pattern"},
"61c338be": {"dfnID":"61c338be","dfnText":"resolve an origin","external":true,"refSections":[{"refs":[{"id":"ref-for-resolve-an-origin"},{"id":"ref-for-resolve-an-origin\u2460"}],"title":"4.1. Integration with Fetch"}],"url":"https://fetch.spec.whatwg.org/#resolve-an-origin"},
"649608b9": {"dfnID":"649608b9","dfnText":"list","external":true,"refSections":[{"refs":[{"id":"ref-for-list"}],"title":"2. Connection Allowlists"},{"refs":[{"id":"ref-for-list\u2460"}],"title":"3.1. Parsing"},{"refs":[{"id":"ref-for-list\u2461"},{"id":"ref-for-list\u2462"}],"title":"3.2. Matching"},{"refs":[{"id":"ref-for-list\u2463"}],"title":"4.2. Integration with HTML"}],"url":"https://infra.spec.whatwg.org/#list"},
"752d140b": {"dfnID":"752d140b","dfnText":"host","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-host"},{"id":"ref-for-concept-host\u2460"}],"title":"3.2. Matching"}],"url":"https://url.spec.whatwg.org/#concept-host"},
"7660bec4": {"dfnID":"7660bec4","dfnText":"parameters","external":true,"refSections":[{"refs":[{"id":"ref-for-name-parameters"}],"title":"3. Connection Allowlist Headers"}],"url":"https://www.rfc-editor.org/rfc/rfc9651#name-parameters"},
"77a2ee6e": {"dfnID":"77a2ee6e","dfnText":"host","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-origin-host"}],"title":"4.1. Integration with Fetch"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host"},
"7ed9d314": {"dfnID":"7ed9d314","dfnText":"generate and queue a report","external":true,"refSections":[{"refs":[{"id":"ref-for-generate-and-queue-a-report"}],"title":"3.3. Reporting"}],"url":"https://w3c.github.io/reporting/#generate-and-queue-a-report"},
"83af367f": {"dfnID":"83af367f","dfnText":"blocked","external":true,"refSections":[{"refs":[{"id":"ref-for-blocked"},{"id":"ref-for-blocked\u2460"},{"id":"ref-for-blocked\u2461"},{"id":"ref-for-blocked\u2462"},{"id":"ref-for-blocked\u2463"},{"id":"ref-for-blocked\u2464"}],"title":"3.2. Matching"},{"refs":[{"id":"ref-for-blocked\u2465"}],"title":"4.1. Integration with Fetch"}],"url":"https://infra.spec.whatwg.org/#blocked"},
"857d5516": {"dfnID":"857d5516","dfnText":"client","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-client"}],"title":"3.2. Matching"}],"url":"https://fetch.spec.whatwg.org/#concept-request-client"},
"86efadaf": {"dfnID":"86efadaf","dfnText":"policy container","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-policy-container"}],"title":"3.2. Matching"}],"url":"https://fetch.spec.whatwg.org/#concept-request-policy-container"},
"8855a9aa": {"dfnID":"8855a9aa","dfnText":"DOMString","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-DOMString"}],"title":"3.3. Reporting"}],"url":"https://webidl.spec.whatwg.org/#idl-DOMString"},
"8e1fb11c": {"dfnID":"8e1fb11c","dfnText":"obtain a connection","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-connection-obtain"},{"id":"ref-for-concept-connection-obtain\u2460"}],"title":"4.1. Integration with Fetch"}],"url":"https://fetch.spec.whatwg.org/#concept-connection-obtain"},
"90f4193a": {"dfnID":"90f4193a","dfnText":"URLPatternInit","external":true,"refSections":[{"refs":[{"id":"ref-for-dictdef-urlpatterninit"}],"title":"3.2. Matching"}],"url":"https://urlpattern.spec.whatwg.org/#dictdef-urlpatterninit"},
"9239678f": {"dfnID":"9239678f","dfnText":"endpoint","external":true,"refSections":[{"refs":[{"id":"ref-for-endpoint"}],"title":"1. Introduction"},{"refs":[{"id":"ref-for-endpoint\u2460"}],"title":"2. Connection Allowlists"},{"refs":[{"id":"ref-for-endpoint\u2461"}],"title":"3. Connection Allowlist Headers"}],"url":"https://w3c.github.io/reporting/#endpoint"},
"959ad97b": {"dfnID":"959ad97b","dfnText":"origin","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-url-origin"}],"title":"3. Connection Allowlist Headers"},{"refs":[{"id":"ref-for-concept-url-origin\u2460"}],"title":"3.1. Parsing"}],"url":"https://url.spec.whatwg.org/#concept-url-origin"},
"984221ca": {"dfnID":"984221ca","dfnText":"struct","external":true,"refSections":[{"refs":[{"id":"ref-for-struct"}],"title":"2. Connection Allowlists"},{"refs":[{"id":"ref-for-struct\u2460"}],"title":"4.2. Integration with HTML"}],"url":"https://infra.spec.whatwg.org/#struct"},
"98b32dd9": {"dfnID":"98b32dd9","dfnText":"success","external":true,"refSections":[{"refs":[{"id":"ref-for-success"},{"id":"ref-for-success\u2460"},{"id":"ref-for-success\u2461"},{"id":"ref-for-success\u2462"}],"title":"3.2. Matching"}],"url":"https://infra.spec.whatwg.org/#success"},
"9a15e8d7": {"dfnID":"9a15e8d7","dfnText":"build a URL pattern from an HTTP structured field value","external":true,"refSections":[{"refs":[{"id":"ref-for-build-a-url-pattern-from-an-http-structured-field-value"}],"title":"3.1. Parsing"}],"url":"https://urlpattern.spec.whatwg.org/#build-a-url-pattern-from-an-http-structured-field-value"},
"9b40f5cd": {"dfnID":"9b40f5cd","dfnText":"fetch directives","external":true,"refSections":[{"refs":[{"id":"ref-for-fetch-directives"}],"title":"1.2. Overlap with Content Security Policy"}],"url":"https://w3c.github.io/webappsec-csp/#fetch-directives"},
"9cce47fd": {"dfnID":"9cce47fd","dfnText":"sequence","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-sequence"}],"title":"3.3. Reporting"}],"url":"https://webidl.spec.whatwg.org/#idl-sequence"},
"a7b0745e": {"dfnID":"a7b0745e","dfnText":"list","external":true,"refSections":[{"refs":[{"id":"ref-for-name-list"}],"title":"3. Connection Allowlist Headers"},{"refs":[{"id":"ref-for-name-list\u2460"},{"id":"ref-for-name-list\u2461"},{"id":"ref-for-name-list\u2462"}],"title":"3.1. Parsing"}],"url":"https://www.rfc-editor.org/rfc/rfc9651#name-list"},
"abstract-opdef-match-a-host-to-a-connection-allowlist": {"dfnID":"abstract-opdef-match-a-host-to-a-connection-allowlist","dfnText":"match a host to a Connection Allowlist","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-match-a-host-to-a-connection-allowlist"}],"title":"3.2. Matching"}],"url":"#abstract-opdef-match-a-host-to-a-connection-allowlist"},
"abstract-opdef-match-a-url-to-a-connection-allowlist": {"dfnID":"abstract-opdef-match-a-url-to-a-connection-allowlist","dfnText":"match a URL to a Connection Allowlist","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-match-a-url-to-a-connection-allowlist"}],"title":"3.2. Matching"}],"url":"#abstract-opdef-match-a-url-to-a-connection-allowlist"},
"abstract-opdef-parse-a-connection-allowlist-header": {"dfnID":"abstract-opdef-parse-a-connection-allowlist-header","dfnText":"parse a Connection Allowlist header","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-parse-a-connection-allowlist-header"},{"id":"ref-for-abstract-opdef-parse-a-connection-allowlist-header\u2460"}],"title":"3.1. Parsing"}],"url":"#abstract-opdef-parse-a-connection-allowlist-header"},
"abstract-opdef-parse-a-responses-connection-allowlists": {"dfnID":"abstract-opdef-parse-a-responses-connection-allowlists","dfnText":"parse a response\u2019s Connection Allowlists","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-parse-a-responses-connection-allowlists"}],"title":"4.2. Integration with HTML"}],"url":"#abstract-opdef-parse-a-responses-connection-allowlists"},
"abstract-opdef-report-a-violation": {"dfnID":"abstract-opdef-report-a-violation","dfnText":"report a violation","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-report-a-violation"},{"id":"ref-for-abstract-opdef-report-a-violation\u2460"}],"title":"3.2. Matching"}],"url":"#abstract-opdef-report-a-violation"},
"abstract-opdef-should-host-be-blocked-by-connection-allowlists": {"dfnID":"abstract-opdef-should-host-be-blocked-by-connection-allowlists","dfnText":"should host be blocked by Connection Allowlists","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-should-host-be-blocked-by-connection-allowlists"}],"title":"4.1. Integration with Fetch"}],"url":"#abstract-opdef-should-host-be-blocked-by-connection-allowlists"},
"abstract-opdef-should-request-be-blocked-by-connection-allowlists": {"dfnID":"abstract-opdef-should-request-be-blocked-by-connection-allowlists","dfnText":"should request be blocked by Connection Allowlists","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-should-request-be-blocked-by-connection-allowlists"}],"title":"4.1. Integration with Fetch"}],"url":"#abstract-opdef-should-request-be-blocked-by-connection-allowlists"},
"abstract-opdef-should-url-be-blocked-by-connection-allowlist": {"dfnID":"abstract-opdef-should-url-be-blocked-by-connection-allowlist","dfnText":"should url be blocked by Connection Allowlist","external":false,"refSections":[{"refs":[{"id":"ref-for-abstract-opdef-should-url-be-blocked-by-connection-allowlist"}],"title":"3.2. Matching"}],"url":"#abstract-opdef-should-url-be-blocked-by-connection-allowlist"},
"ae56d57e": {"dfnID":"ae56d57e","dfnText":"URL list","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-url-list"}],"title":"3.2. Matching"}],"url":"https://fetch.spec.whatwg.org/#concept-request-url-list"},
"b0d7f3c3": {"dfnID":"b0d7f3c3","dfnText":"USVString","external":true,"refSections":[{"refs":[{"id":"ref-for-idl-USVString"},{"id":"ref-for-idl-USVString\u2460"}],"title":"3.3. Reporting"}],"url":"https://webidl.spec.whatwg.org/#idl-USVString"},
"b33787b2": {"dfnID":"b33787b2","dfnText":"policy container","external":true,"refSections":[{"refs":[{"id":"ref-for-policy-container"}],"title":"1.1. Threat Model"},{"refs":[{"id":"ref-for-policy-container\u2460"}],"title":"4.2. Integration with HTML"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#policy-container"},
"b410a6ef": {"dfnID":"b410a6ef","dfnText":"ASCII serialization of an origin","external":true,"refSections":[{"refs":[{"id":"ref-for-ascii-serialisation-of-an-origin"}],"title":"3.1. Parsing"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#ascii-serialisation-of-an-origin"},
"bf8d9616": {"dfnID":"bf8d9616","dfnText":"failure","external":true,"refSections":[{"refs":[{"id":"ref-for-failure"},{"id":"ref-for-failure\u2460"},{"id":"ref-for-failure\u2461"},{"id":"ref-for-failure\u2462"}],"title":"3.2. Matching"},{"refs":[{"id":"ref-for-failure\u2463"}],"title":"4.1. Integration with Fetch"}],"url":"https://infra.spec.whatwg.org/#failure"},
"bf9f0d4e": {"dfnID":"bf9f0d4e","dfnText":"create","external":true,"refSections":[{"refs":[{"id":"ref-for-url-pattern-create"}],"title":"3.2. Matching"}],"url":"https://urlpattern.spec.whatwg.org/#url-pattern-create"},
"c88f3887": {"dfnID":"c88f3887","dfnText":"item","external":true,"refSections":[{"refs":[{"id":"ref-for-struct-item"}],"title":"2. Connection Allowlists"}],"url":"https://infra.spec.whatwg.org/#struct-item"},
"c9aec5e7": {"dfnID":"c9aec5e7","dfnText":"string","external":true,"refSections":[{"refs":[{"id":"ref-for-name-string"}],"title":"3. Connection Allowlist Headers"}],"url":"https://www.rfc-editor.org/rfc/rfc9651#name-string"},
"c9e7c11a": {"dfnID":"c9e7c11a","dfnText":"header","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-header"},{"id":"ref-for-concept-header\u2460"}],"title":"3. Connection Allowlist Headers"}],"url":"https://fetch.spec.whatwg.org/#concept-header"},
"ca3ca4ae": {"dfnID":"ca3ca4ae","dfnText":"URL parser","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-url-parser"}],"title":"3.2. Matching"}],"url":"https://url.spec.whatwg.org/#concept-url-parser"},
"cfb6031b": {"dfnID":"cfb6031b","dfnText":"creating a policy container from a fetch response","external":true,"refSections":[{"refs":[{"id":"ref-for-creating-a-policy-container-from-a-fetch-response"}],"title":"4.2. Integration with HTML"}],"url":"https://html.spec.whatwg.org/multipage/browsers.html#creating-a-policy-container-from-a-fetch-response"},
"cfe36e16": {"dfnID":"cfe36e16","dfnText":"Reporting-Endpoints","external":true,"refSections":[{"refs":[{"id":"ref-for-reporting-endpoints"}],"title":"1. Introduction"}],"url":"https://w3c.github.io/reporting/#reporting-endpoints"},
"connection-allowlist": {"dfnID":"connection-allowlist","dfnText":"Connection Allowlist","external":false,"refSections":[{"refs":[{"id":"ref-for-connection-allowlist"}],"title":"3.1. Parsing"},{"refs":[{"id":"ref-for-connection-allowlist\u2460"},{"id":"ref-for-connection-allowlist\u2461"}],"title":"3.2. Matching"},{"refs":[{"id":"ref-for-connection-allowlist\u2462"}],"title":"3.3. Reporting"}],"url":"#connection-allowlist"},
"connection-allowlist-allowlist": {"dfnID":"connection-allowlist-allowlist","dfnText":"allowlist","external":false,"refSections":[{"refs":[{"id":"ref-for-connection-allowlist-allowlist"}],"title":"3.1. Parsing"},{"refs":[{"id":"ref-for-connection-allowlist-allowlist\u2460"},{"id":"ref-for-connection-allowlist-allowlist\u2461"},{"id":"ref-for-connection-allowlist-allowlist\u2462"}],"title":"3.2. Matching"},{"refs":[{"id":"ref-for-connection-allowlist-allowlist\u2463"},{"id":"ref-for-connection-allowlist-allowlist\u2464"}],"title":"3.3. Reporting"}],"url":"#connection-allowlist-allowlist"},
"connection-allowlist-disposition": {"dfnID":"connection-allowlist-disposition","dfnText":"disposition","external":false,"refSections":[{"refs":[{"id":"ref-for-connection-allowlist-disposition"},{"id":"ref-for-connection-allowlist-disposition\u2460"}],"title":"3.1. Parsing"},{"refs":[{"id":"ref-for-connection-allowlist-disposition\u2461"},{"id":"ref-for-connection-allowlist-disposition\u2462"}],"title":"3.2. Matching"},{"refs":[{"id":"ref-for-connection-allowlist-disposition\u2463"},{"id":"ref-for-connection-allowlist-disposition\u2464"}],"title":"3.3. Reporting"}],"url":"#connection-allowlist-disposition"},
"connection-allowlist-reporting-endpoint": {"dfnID":"connection-allowlist-reporting-endpoint","dfnText":"reporting endpoint","external":false,"refSections":[{"refs":[{"id":"ref-for-connection-allowlist-reporting-endpoint"}],"title":"3.1. Parsing"},{"refs":[{"id":"ref-for-connection-allowlist-reporting-endpoint\u2460"},{"id":"ref-for-connection-allowlist-reporting-endpoint\u2461"}],"title":"3.3. Reporting"}],"url":"#connection-allowlist-reporting-endpoint"},
"d06b2b8c": {"dfnID":"d06b2b8c","dfnText":"XMLHttpRequest","external":true,"refSections":[{"refs":[{"id":"ref-for-xmlhttprequest"}],"title":"1.1. Threat Model"}],"url":"https://xhr.spec.whatwg.org/#xmlhttprequest"},
"d762bbef": {"dfnID":"d762bbef","dfnText":"hostname","external":true,"refSections":[{"refs":[{"id":"ref-for-dom-urlpatterninit-hostname"}],"title":"3.2. Matching"}],"url":"https://urlpattern.spec.whatwg.org/#dom-urlpatterninit-hostname"},
"daf5c14d": {"dfnID":"daf5c14d","dfnText":"allowed","external":true,"refSections":[{"refs":[{"id":"ref-for-allowed"},{"id":"ref-for-allowed\u2460"},{"id":"ref-for-allowed\u2461"},{"id":"ref-for-allowed\u2462"},{"id":"ref-for-allowed\u2463"}],"title":"3.2. Matching"}],"url":"https://infra.spec.whatwg.org/#allowed"},
"dc1cd39b": {"dfnID":"dc1cd39b","dfnText":"URL (for request)","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-request-url"}],"title":"3.2. Matching"},{"refs":[{"id":"ref-for-concept-request-url\u2460"},{"id":"ref-for-concept-request-url\u2461"}],"title":"3.3. Reporting"}],"url":"https://fetch.spec.whatwg.org/#concept-request-url"},
"dcffbccd": {"dfnID":"dcffbccd","dfnText":"URL","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-url"}],"title":"3.1. Parsing"},{"refs":[{"id":"ref-for-concept-url\u2460"},{"id":"ref-for-concept-url\u2461"},{"id":"ref-for-concept-url\u2462"}],"title":"3.2. Matching"},{"refs":[{"id":"ref-for-concept-url\u2463"},{"id":"ref-for-concept-url\u2464"}],"title":"3.3. Reporting"}],"url":"https://url.spec.whatwg.org/#concept-url"},
"de2211fe": {"dfnID":"de2211fe","dfnText":"structured header","external":true,"refSections":[{"refs":[{"id":"ref-for-name-introduction"}],"title":"3. Connection Allowlist Headers"},{"refs":[{"id":"ref-for-name-introduction\u2460"},{"id":"ref-for-name-introduction\u2461"}],"title":"3.1. Parsing"}],"url":"https://www.rfc-editor.org/rfc/rfc9651#name-introduction"},
"dictdef-connectionallowlistviolationreport": {"dfnID":"dictdef-connectionallowlistviolationreport","dfnText":"ConnectionAllowlistViolationReport","external":false,"refSections":[{"refs":[{"id":"ref-for-dictdef-connectionallowlistviolationreport"},{"id":"ref-for-dictdef-connectionallowlistviolationreport\u2460"},{"id":"ref-for-dictdef-connectionallowlistviolationreport\u2461"},{"id":"ref-for-dictdef-connectionallowlistviolationreport\u2462"}],"title":"3.3. Reporting"}],"url":"#dictdef-connectionallowlistviolationreport"},
"dom-connectionallowlistdisposition-enforce": {"dfnID":"dom-connectionallowlistdisposition-enforce","dfnText":"\"enforce\"","external":false,"refSections":[],"url":"#dom-connectionallowlistdisposition-enforce"},
"dom-connectionallowlistdisposition-report": {"dfnID":"dom-connectionallowlistdisposition-report","dfnText":"\"report\"","external":false,"refSections":[],"url":"#dom-connectionallowlistdisposition-report"},
"dom-connectionallowlistviolationreport-allowlist": {"dfnID":"dom-connectionallowlistviolationreport-allowlist","dfnText":"allowlist","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-connectionallowlistviolationreport-allowlist"},{"id":"ref-for-dom-connectionallowlistviolationreport-allowlist\u2460"},{"id":"ref-for-dom-connectionallowlistviolationreport-allowlist\u2461"}],"title":"3.3. Reporting"}],"url":"#dom-connectionallowlistviolationreport-allowlist"},
"dom-connectionallowlistviolationreport-connection": {"dfnID":"dom-connectionallowlistviolationreport-connection","dfnText":"connection","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-connectionallowlistviolationreport-connection"},{"id":"ref-for-dom-connectionallowlistviolationreport-connection\u2460"}],"title":"3.3. Reporting"}],"url":"#dom-connectionallowlistviolationreport-connection"},
"dom-connectionallowlistviolationreport-disposition": {"dfnID":"dom-connectionallowlistviolationreport-disposition","dfnText":"disposition","external":false,"refSections":[{"refs":[{"id":"ref-for-dom-connectionallowlistviolationreport-disposition"},{"id":"ref-for-dom-connectionallowlistviolationreport-disposition\u2460"}],"title":"3.3. Reporting"}],"url":"#dom-connectionallowlistviolationreport-disposition"},
"dom-connectionallowlistviolationreport-url": {"dfnID":"dom-connectionallowlistviolationreport-url","dfnText":"url","external":false,"refSections":[],"url":"#dom-connectionallowlistviolationreport-url"},
"ee7bba09": {"dfnID":"ee7bba09","dfnText":"response","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-response"}],"title":"3. Connection Allowlist Headers"},{"refs":[{"id":"ref-for-concept-response\u2460"}],"title":"3.1. Parsing"}],"url":"https://fetch.spec.whatwg.org/#concept-response"},
"enumdef-connectionallowlistdisposition": {"dfnID":"enumdef-connectionallowlistdisposition","dfnText":"ConnectionAllowlistDisposition","external":false,"refSections":[{"refs":[{"id":"ref-for-enumdef-connectionallowlistdisposition"}],"title":"3.3. Reporting"}],"url":"#enumdef-connectionallowlistdisposition"},
"f02cd417": {"dfnID":"f02cd417","dfnText":"iterate","external":true,"refSections":[{"refs":[{"id":"ref-for-list-iterate"},{"id":"ref-for-list-iterate\u2460"}],"title":"3.1. Parsing"},{"refs":[{"id":"ref-for-list-iterate\u2461"},{"id":"ref-for-list-iterate\u2462"},{"id":"ref-for-list-iterate\u2463"},{"id":"ref-for-list-iterate\u2464"}],"title":"3.2. Matching"}],"url":"https://infra.spec.whatwg.org/#list-iterate"},
"f7b00a8b": {"dfnID":"f7b00a8b","dfnText":"header list","external":true,"refSections":[{"refs":[{"id":"ref-for-concept-response-header-list"},{"id":"ref-for-concept-response-header-list\u2460"}],"title":"3.1. Parsing"}],"url":"https://fetch.spec.whatwg.org/#concept-response-header-list"},
"f937b7b6": {"dfnID":"f937b7b6","dfnText":"continue","external":true,"refSections":[{"refs":[{"id":"ref-for-iteration-continue"},{"id":"ref-for-iteration-continue\u2460"}],"title":"3.1. Parsing"},{"refs":[{"id":"ref-for-iteration-continue\u2461"},{"id":"ref-for-iteration-continue\u2462"}],"title":"3.2. Matching"}],"url":"https://infra.spec.whatwg.org/#iteration-continue"},
"grammardef-connection-allowlist-disposition-enforce": {"dfnID":"grammardef-connection-allowlist-disposition-enforce","dfnText":"enforce","external":false,"refSections":[{"refs":[{"id":"ref-for-grammardef-connection-allowlist-disposition-enforce"}],"title":"3.1. Parsing"},{"refs":[{"id":"ref-for-grammardef-connection-allowlist-disposition-enforce\u2460"},{"id":"ref-for-grammardef-connection-allowlist-disposition-enforce\u2461"}],"title":"3.2. Matching"}],"url":"#grammardef-connection-allowlist-disposition-enforce"},
"grammardef-connection-allowlist-disposition-report": {"dfnID":"grammardef-connection-allowlist-disposition-report","dfnText":"report","external":false,"refSections":[{"refs":[{"id":"ref-for-grammardef-connection-allowlist-disposition-report"}],"title":"3.1. Parsing"}],"url":"#grammardef-connection-allowlist-disposition-report"},
"grammardef-connection-allowlist-report-to": {"dfnID":"grammardef-connection-allowlist-report-to","dfnText":"report-to","external":false,"refSections":[{"refs":[{"id":"ref-for-grammardef-connection-allowlist-report-to"}],"title":"3.1. Parsing"}],"url":"#grammardef-connection-allowlist-report-to"},
"grammardef-connection-allowlist-response-origin": {"dfnID":"grammardef-connection-allowlist-response-origin","dfnText":"response-origin","external":false,"refSections":[{"refs":[{"id":"ref-for-grammardef-connection-allowlist-response-origin"}],"title":"3.1. Parsing"}],"url":"#grammardef-connection-allowlist-response-origin"},
"http-headerdef-connection-allowlist": {"dfnID":"http-headerdef-connection-allowlist","dfnText":"Connection-Allowlist","external":false,"refSections":[{"refs":[{"id":"ref-for-http-headerdef-connection-allowlist"}],"title":"1. Introduction"},{"refs":[{"id":"ref-for-http-headerdef-connection-allowlist\u2460"}],"title":"3.1. Parsing"}],"url":"#http-headerdef-connection-allowlist"},
"http-headerdef-connection-allowlist-report-only": {"dfnID":"http-headerdef-connection-allowlist-report-only","dfnText":"Connection-Allowlist-Report-Only","external":false,"refSections":[{"refs":[{"id":"ref-for-http-headerdef-connection-allowlist-report-only"}],"title":"3.1. Parsing"}],"url":"#http-headerdef-connection-allowlist-report-only"},
"policy-container-connection-allowlists": {"dfnID":"policy-container-connection-allowlists","dfnText":"connection allowlists","external":false,"refSections":[{"refs":[{"id":"ref-for-policy-container-connection-allowlists"},{"id":"ref-for-policy-container-connection-allowlists\u2460"},{"id":"ref-for-policy-container-connection-allowlists\u2461"}],"title":"3.2. Matching"},{"refs":[{"id":"ref-for-policy-container-connection-allowlists\u2462"},{"id":"ref-for-policy-container-connection-allowlists\u2463"}],"title":"4.2. Integration with HTML"}],"url":"#policy-container-connection-allowlists"},
};

document.addEventListener("DOMContentLoaded", ()=>{
    genAllDfnPanels();

    document.body.addEventListener("click", (e) => {
        // If not handled already, just hide all dfn panels.
        hideAllDfnPanels();
    });
});

window.addEventListener("resize", () => {
    // Pin any visible dfn panel
    queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>positionDfnPanel(el));
});

function genAllDfnPanels() {
    for(const panelData of Object.values(dfnPanelData)) {
        const dfnID = panelData.dfnID;
        const dfn = document.getElementById(dfnID);
        if(!dfn) {
            console.log(`Can't find dfn#${dfnID}.`, panelData);
            continue;
        }
        dfn.panelData = panelData;
        insertDfnPopupAction(dfn);
    }
}

function genDfnPanel(dfn, { dfnID, url, dfnText, refSections, external }) {
    const dfnPanel = mk.aside({
        class: "dfn-panel on",
        id: `infopanel-for-${dfnID}`,
        "data-for": dfnID,
        "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
        },
        mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
            `Info about the '${dfnText}' ${external?"external":""} reference.`),
        mk.a({href:url, class:"dfn-link"}, url),
        refSections.length == 0 ? [] :
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({ href: `#${ref.id}` },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        genLinkingSyntaxes(dfn),
    );

    dfnPanel.addEventListener('click', (event) => {
        if (event.target.nodeName == 'A') {
            scrollToTargetAndHighlight(event);
            pinDfnPanel(dfnPanel);
        }
        event.stopPropagation();
        refocusOnTarget(event);
    });
    dfnPanel.addEventListener('keydown', (event) => {
        if(event.keyCode == 27) { // Escape key
            hideDfnPanel({dfnPanel});
            event.stopPropagation();
            event.preventDefault();
        }
    });

    dfnPanel.dfn = dfn;
    dfn.dfnPanel = dfnPanel;
    return dfnPanel;
}



function hideAllDfnPanels() {
    // Delete the currently-active dfn panel.
    queryAll(".dfn-panel").forEach(dfnPanel=>hideDfnPanel({dfnPanel}));
}

function showDfnPanel(dfn) {
    hideAllDfnPanels(); // Only display one at a time.

    dfn.setAttribute("aria-expanded", "true");

    const dfnPanel = genDfnPanel(dfn, dfn.panelData);

    // Give the dfn a unique tabindex, and then
    // give all the tabbable panel bits successive indexes.
    let tabIndex = 100;
    dfn.tabIndex = tabIndex++;
    const tabbable = dfnPanel.querySelectorAll(":is(a, button)");
    for (const el of tabbable) {
        el.tabIndex = tabIndex++;
    }

    append(document.body, dfnPanel);
    positionDfnPanel(dfnPanel);
}

function positionDfnPanel(dfnPanel) {
    const dfn = dfnPanel.dfn;
    const dfnPos = getBounds(dfn);
    dfnPanel.style.top = dfnPos.bottom + "px";
    dfnPanel.style.left = dfnPos.left + "px";

    const panelPos = dfnPanel.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, dfnPos.left - overflowAmount);
        dfnPanel.style.left = newLeft + "px";
    }
}

function pinDfnPanel(dfnPanel) {
    // Switch it to "activated" state, which pins it.
    dfnPanel.classList.add("activated");
    dfnPanel.style.position = "fixed";
    dfnPanel.style.left = null;
    dfnPanel.style.top = null;
}

function hideDfnPanel({dfn, dfnPanel}) {
    if(!dfnPanel) dfnPanel = dfn.dfnPanel;
    if(!dfn) dfn = dfnPanel.dfn;
    dfn.dfnPanel = undefined;
    dfnPanel.dfn = undefined;
    dfn.setAttribute("aria-expanded", "false");
    dfn.tabIndex = undefined;
    dfnPanel.remove()
}

function toggleDfnPanel(dfn) {
    if(dfn.dfnPanel) {
        hideDfnPanel(dfn);
    } else {
        showDfnPanel(dfn);
    }
}

function insertDfnPopupAction(dfn) {
    dfn.setAttribute('role', 'button');
    dfn.setAttribute('aria-expanded', 'false')
    dfn.tabIndex = 0;
    dfn.classList.add('has-dfn-panel');
    dfn.addEventListener('click', (event) => {
        toggleDfnPanel(dfn);
        event.stopPropagation();
    });
    dfn.addEventListener('keypress', (event) => {
        const kc = event.keyCode;
        // 32->Space, 13->Enter
        if(kc == 32 || kc == 13) {
            toggleDfnPanel(dfn);
            event.stopPropagation();
            event.preventDefault();
        }
    });
}

function refocusOnTarget(event) {
    const target = event.target;
    setTimeout(() => {
        // Refocus on the event.target element.
        // This is needed after browser scrolls to the destination.
        target.focus();
    });
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function scrollToTargetAndHighlight(event) {
    let hash = event.target.hash;
    if (hash) {
        hash = decodeURIComponent(hash.substring(1));
        const dest = document.getElementById(hash);
        if (dest) {
            dest.classList.add('highlighted');
            setTimeout(() => dest.classList.remove('highlighted'), 1000);
        }
    }
}

// Functions, divided by link type, that wrap an autolink's
// contents with the appropriate outer syntax.
// Alternately, a string naming another type they format
// the same as.
function needsFor(type) {
    switch(type) {
        case "descriptor":
        case "value":
        case "element-attr":
        case "attr-value":
        case "element-state":
        case "method":
        case "constructor":
        case "argument":
        case "attribute":
        case "const":
        case "dict-member":
        case "event":
        case "enum-value":
        case "stringifier":
        case "serializer":
        case "iterator":
        case "maplike":
        case "setlike":
        case "state":
        case "mode":
        case "context":
        case "facet": return true;

        default: return false;
    }
}
function refusesFor(type) {
    switch(type) {
        case "property":
        case "element":
        case "interface":
        case "namespace":
        case "callback":
        case "dictionary":
        case "enum":
        case "exception":
        case "typedef":
        case "http-header":
        case "permission": return true;

        default: return false;
    }
}
function linkFormatterFromType(type) {
    switch(type) {
        case 'scheme':
        case 'permission':
        case 'dfn': return (text) => `[=${text}=]`;

        case 'abstract-op': return (text) => `[\$${text}\$]`;

        case 'function':
        case 'at-rule':
        case 'selector':
        case 'value': return (text) => `''${text}''`;

        case 'http-header': return (text) => `[:${text}:]`;

        case 'interface':
        case 'constructor':
        case 'method':
        case 'argument':
        case 'attribute':
        case 'callback':
        case 'dictionary':
        case 'dict-member':
        case 'enum':
        case 'enum-value':
        case 'exception':
        case 'const':
        case 'typedef':
        case 'stringifier':
        case 'serializer':
        case 'iterator':
        case 'maplike':
        case 'setlike':
        case 'extended-attribute':
        case 'event':
        case 'idl': return (text) => `{{${text}}}`;

        case 'element-state':
        case 'element-attr':
        case 'attr-value':
        case 'element': return (element) => `<{${element}}>`;

        case 'grammar': return (text) => `${text} (within a <pre class=prod>)`;

        case 'type': return (text)=> `<<${text}>>`;

        case 'descriptor':
        case 'property': return (text) => `'${text}'`;

        default: return;
    };
};

function genLinkingSyntaxes(dfn) {
    if(dfn.tagName != "DFN") return;

    const type = dfn.getAttribute('data-dfn-type');
    if(!type) {
        console.log(`<dfn> doesn't have a data-dfn-type:`, dfn);
        return [];
    }

    // Return a function that wraps link text based on the type
    const linkFormatter = linkFormatterFromType(type);
    if(!linkFormatter) {
        console.log(`<dfn> has an unknown data-dfn-type:`, dfn);
        return [];
    }

    let ltAlts;
    if(dfn.hasAttribute('data-lt')) {
        ltAlts = dfn.getAttribute('data-lt')
            .split("|")
            .map(x=>x.trim());
    } else {
        ltAlts = [dfn.textContent.trim()];
    }
    if(type == "type") {
        // lt of "<foo>", but "foo" is the interior;
        // <<foo/bar>> is how you write it with a for,
        // not <foo/<bar>> or whatever.
        for(var i = 0; i < ltAlts.length; i++) {
            const lt = ltAlts[i];
            const match = /<(.*)>/.exec(lt);
            if(match) { ltAlts[i] = match[1]; }
        }
    }

    let forAlts;
    if(dfn.hasAttribute('data-dfn-for')) {
        forAlts = dfn.getAttribute('data-dfn-for')
            .split(",")
            .map(x=>x.trim());
    } else {
        forAlts = [''];
    }

    let linkingSyntaxes = [];
    if(!needsFor(type)) {
        for(const lt of ltAlts) {
            linkingSyntaxes.push(linkFormatter(lt));
        }
    }
    if(!refusesFor(type)) {
        for(const f of forAlts) {
            linkingSyntaxes.push(linkFormatter(`${f}/${ltAlts[0]}`))
        }
    }
    return [
        mk.b({}, 'Possible linking syntaxes:'),
        mk.ul({},
            ...linkingSyntaxes.map(link => {
                const copyLink = async () =>
                    await navigator.clipboard.writeText(link);
                return mk.li({},
                    mk.div({ class: 'link-item' },
                        mk.button({
                            class: 'copy-icon', title: 'Copy',
                            type: 'button',
                            _onclick: copyLink,
                            tabindex: 0,
                        }, mk.span({ class: 'icon' }) ),
                        mk.span({}, link)
                    )
                );
            })
        )
    ];
}
}
</script>
<script>/* Boilerplate: script-ref-hints */
"use strict";
{
let refsData = {
"#abstract-opdef-match-a-host-to-a-connection-allowlist": {"displayText":"match host","export":true,"for_":[],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"match host","type":"abstract-op","url":"#abstract-opdef-match-a-host-to-a-connection-allowlist"},
"#abstract-opdef-match-a-url-to-a-connection-allowlist": {"displayText":"matches","export":true,"for_":[],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"matches","type":"abstract-op","url":"#abstract-opdef-match-a-url-to-a-connection-allowlist"},
"#abstract-opdef-parse-a-connection-allowlist-header": {"displayText":"parse header","export":true,"for_":[],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"parse header","type":"abstract-op","url":"#abstract-opdef-parse-a-connection-allowlist-header"},
"#abstract-opdef-parse-a-responses-connection-allowlists": {"displayText":"parse a response's Connection Allowlists","export":true,"for_":[],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"parse a response's Connection Allowlists","type":"abstract-op","url":"#abstract-opdef-parse-a-responses-connection-allowlists"},
"#abstract-opdef-report-a-violation": {"displayText":"report","export":true,"for_":[],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"report","type":"abstract-op","url":"#abstract-opdef-report-a-violation"},
"#abstract-opdef-should-host-be-blocked-by-connection-allowlists": {"displayText":"should host be blocked by Connection Allowlists","export":true,"for_":[],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"should host be blocked by Connection Allowlists","type":"abstract-op","url":"#abstract-opdef-should-host-be-blocked-by-connection-allowlists"},
"#abstract-opdef-should-request-be-blocked-by-connection-allowlists": {"displayText":"should request be blocked by Connection Allowlists","export":true,"for_":[],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"should request be blocked by Connection Allowlists","type":"abstract-op","url":"#abstract-opdef-should-request-be-blocked-by-connection-allowlists"},
"#abstract-opdef-should-url-be-blocked-by-connection-allowlist": {"displayText":"should url be blocked by Connection Allowlist","export":true,"for_":[],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"should url be blocked by Connection Allowlist","type":"abstract-op","url":"#abstract-opdef-should-url-be-blocked-by-connection-allowlist"},
"#connection-allowlist": {"displayText":"connection allowlist","export":true,"for_":[],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"connection allowlist","type":"dfn","url":"#connection-allowlist"},
"#connection-allowlist-allowlist": {"displayText":"allowlist","export":true,"for_":["Connection Allowlist"],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"allowlist","type":"dfn","url":"#connection-allowlist-allowlist"},
"#connection-allowlist-disposition": {"displayText":"disposition","export":true,"for_":["Connection Allowlist"],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"disposition","type":"dfn","url":"#connection-allowlist-disposition"},
"#connection-allowlist-reporting-endpoint": {"displayText":"reporting endpoint","export":true,"for_":["Connection Allowlist"],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"reporting endpoint","type":"dfn","url":"#connection-allowlist-reporting-endpoint"},
"#dictdef-connectionallowlistviolationreport": {"displayText":"ConnectionAllowlistViolationReport","export":true,"for_":[],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"ConnectionAllowlistViolationReport","type":"dictionary","url":"#dictdef-connectionallowlistviolationreport"},
"#dom-connectionallowlistviolationreport-allowlist": {"displayText":"allowlist","export":true,"for_":["ConnectionAllowlistViolationReport"],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"allowlist","type":"dict-member","url":"#dom-connectionallowlistviolationreport-allowlist"},
"#dom-connectionallowlistviolationreport-connection": {"displayText":"connection","export":true,"for_":["ConnectionAllowlistViolationReport"],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"connection","type":"dict-member","url":"#dom-connectionallowlistviolationreport-connection"},
"#dom-connectionallowlistviolationreport-disposition": {"displayText":"disposition","export":true,"for_":["ConnectionAllowlistViolationReport"],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"disposition","type":"dict-member","url":"#dom-connectionallowlistviolationreport-disposition"},
"#enumdef-connectionallowlistdisposition": {"displayText":"ConnectionAllowlistDisposition","export":true,"for_":[],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"ConnectionAllowlistDisposition","type":"enum","url":"#enumdef-connectionallowlistdisposition"},
"#grammardef-connection-allowlist-disposition-enforce": {"displayText":"enforce","export":true,"for_":["Connection Allowlist/disposition"],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"enforce","type":"grammar","url":"#grammardef-connection-allowlist-disposition-enforce"},
"#grammardef-connection-allowlist-disposition-report": {"displayText":"report","export":true,"for_":["Connection Allowlist/disposition"],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"report","type":"grammar","url":"#grammardef-connection-allowlist-disposition-report"},
"#grammardef-connection-allowlist-report-to": {"displayText":"report-to","export":true,"for_":["Connection-Allowlist"],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"report-to","type":"grammar","url":"#grammardef-connection-allowlist-report-to"},
"#grammardef-connection-allowlist-response-origin": {"displayText":"response-origin","export":true,"for_":["Connection-Allowlist"],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"response-origin","type":"grammar","url":"#grammardef-connection-allowlist-response-origin"},
"#http-headerdef-connection-allowlist": {"displayText":"connection-allowlist","export":true,"for_":[],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"connection-allowlist","type":"http-header","url":"#http-headerdef-connection-allowlist"},
"#http-headerdef-connection-allowlist-report-only": {"displayText":"connection-allowlist-report-only","export":true,"for_":[],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"connection-allowlist-report-only","type":"http-header","url":"#http-headerdef-connection-allowlist-report-only"},
"#policy-container-connection-allowlists": {"displayText":"connection allowlists","export":true,"for_":["policy container"],"level":"1","normative":true,"shortname":"connection-allowlists","spec":"connection-allowlists-1","status":"local","text":"connection allowlists","type":"dfn","url":"#policy-container-connection-allowlists"},
"https://fetch.spec.whatwg.org/#concept-connection-obtain": {"displayText":"obtain a connection","export":true,"for_":[],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"obtain a connection","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-connection-obtain"},
"https://fetch.spec.whatwg.org/#concept-header": {"displayText":"header","export":true,"for_":[],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"header","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-header"},
"https://fetch.spec.whatwg.org/#concept-header-list-get-structured-header": {"displayText":"get a structured field value","export":true,"for_":["header list"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"get a structured field value","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-header-list-get-structured-header"},
"https://fetch.spec.whatwg.org/#concept-request": {"displayText":"request","export":true,"for_":[],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"request","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request"},
"https://fetch.spec.whatwg.org/#concept-request-client": {"displayText":"client","export":true,"for_":["request"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"client","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request-client"},
"https://fetch.spec.whatwg.org/#concept-request-current-url": {"displayText":"current URL","export":true,"for_":["request"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"current url","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request-current-url"},
"https://fetch.spec.whatwg.org/#concept-request-policy-container": {"displayText":"policy container","export":true,"for_":["request"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"policy container","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request-policy-container"},
"https://fetch.spec.whatwg.org/#concept-request-url": {"displayText":"URL","export":true,"for_":["request"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"url","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request-url"},
"https://fetch.spec.whatwg.org/#concept-request-url-list": {"displayText":"URL list","export":true,"for_":["request"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"url list","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-request-url-list"},
"https://fetch.spec.whatwg.org/#concept-response": {"displayText":"response","export":true,"for_":[],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"response","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-response"},
"https://fetch.spec.whatwg.org/#concept-response-header-list": {"displayText":"header list","export":true,"for_":["response"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"header list","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-response-header-list"},
"https://fetch.spec.whatwg.org/#concept-response-url": {"displayText":"URL","export":true,"for_":["response"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"url","type":"dfn","url":"https://fetch.spec.whatwg.org/#concept-response-url"},
"https://fetch.spec.whatwg.org/#dom-global-fetch": {"displayText":"fetch(input)","export":true,"for_":["WindowOrWorkerGlobalScope"],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"fetch(input)","type":"method","url":"https://fetch.spec.whatwg.org/#dom-global-fetch"},
"https://fetch.spec.whatwg.org/#resolve-an-origin": {"displayText":"resolve an origin","export":true,"for_":[],"level":"1","normative":true,"shortname":"fetch","spec":"fetch","status":"current","text":"resolve an origin","type":"dfn","url":"https://fetch.spec.whatwg.org/#resolve-an-origin"},
"https://html.spec.whatwg.org/multipage/browsers.html#ascii-serialisation-of-an-origin": {"displayText":"ASCII serialization of an origin","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"ascii serialization of an origin","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#ascii-serialisation-of-an-origin"},
"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host": {"displayText":"host","export":true,"for_":["origin"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"host","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#concept-origin-host"},
"https://html.spec.whatwg.org/multipage/browsers.html#creating-a-policy-container-from-a-fetch-response": {"displayText":"creating a policy container from a fetch response","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"creating a policy container from a fetch response","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#creating-a-policy-container-from-a-fetch-response"},
"https://html.spec.whatwg.org/multipage/browsers.html#policy-container": {"displayText":"policy container","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"policy container","type":"dfn","url":"https://html.spec.whatwg.org/multipage/browsers.html#policy-container"},
"https://html.spec.whatwg.org/multipage/links.html#link-type-dns-prefetch": {"displayText":"dns-prefetch","export":true,"for_":["link/rel"],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"dns-prefetch","type":"attr-value","url":"https://html.spec.whatwg.org/multipage/links.html#link-type-dns-prefetch"},
"https://html.spec.whatwg.org/multipage/webappapis.html#environment": {"displayText":"environment","export":true,"for_":[],"level":"1","normative":true,"shortname":"html","spec":"html","status":"current","text":"environment","type":"dfn","url":"https://html.spec.whatwg.org/multipage/webappapis.html#environment"},
"https://infra.spec.whatwg.org/#allowed": {"displayText":"allowed","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"allowed","type":"dfn","url":"https://infra.spec.whatwg.org/#allowed"},
"https://infra.spec.whatwg.org/#blocked": {"displayText":"blocked","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"blocked","type":"dfn","url":"https://infra.spec.whatwg.org/#blocked"},
"https://infra.spec.whatwg.org/#failure": {"displayText":"failure","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"failure","type":"dfn","url":"https://infra.spec.whatwg.org/#failure"},
"https://infra.spec.whatwg.org/#iteration-continue": {"displayText":"continue","export":true,"for_":["iteration"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"continue","type":"dfn","url":"https://infra.spec.whatwg.org/#iteration-continue"},
"https://infra.spec.whatwg.org/#list": {"displayText":"list","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"list","type":"dfn","url":"https://infra.spec.whatwg.org/#list"},
"https://infra.spec.whatwg.org/#list-append": {"displayText":"append","export":true,"for_":["list"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"append","type":"dfn","url":"https://infra.spec.whatwg.org/#list-append"},
"https://infra.spec.whatwg.org/#list-insert": {"displayText":"insert","export":true,"for_":["list","set"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"insert","type":"dfn","url":"https://infra.spec.whatwg.org/#list-insert"},
"https://infra.spec.whatwg.org/#list-iterate": {"displayText":"iterate","export":true,"for_":["list","set"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"iterate","type":"dfn","url":"https://infra.spec.whatwg.org/#list-iterate"},
"https://infra.spec.whatwg.org/#list-size": {"displayText":"size","export":true,"for_":["list","stack","queue","set"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"size","type":"dfn","url":"https://infra.spec.whatwg.org/#list-size"},
"https://infra.spec.whatwg.org/#ordered-map": {"displayText":"map","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"map","type":"dfn","url":"https://infra.spec.whatwg.org/#ordered-map"},
"https://infra.spec.whatwg.org/#string": {"displayText":"string","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"string","type":"dfn","url":"https://infra.spec.whatwg.org/#string"},
"https://infra.spec.whatwg.org/#struct": {"displayText":"struct","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"struct","type":"dfn","url":"https://infra.spec.whatwg.org/#struct"},
"https://infra.spec.whatwg.org/#struct-item": {"displayText":"item","export":true,"for_":["struct","tuple"],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"item","type":"dfn","url":"https://infra.spec.whatwg.org/#struct-item"},
"https://infra.spec.whatwg.org/#success": {"displayText":"success","export":true,"for_":[],"level":"1","normative":true,"shortname":"infra","spec":"infra","status":"current","text":"success","type":"dfn","url":"https://infra.spec.whatwg.org/#success"},
"https://url.spec.whatwg.org/#concept-host": {"displayText":"host","export":true,"for_":[],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"host","type":"dfn","url":"https://url.spec.whatwg.org/#concept-host"},
"https://url.spec.whatwg.org/#concept-url": {"displayText":"URL","export":true,"for_":[],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"url","type":"dfn","url":"https://url.spec.whatwg.org/#concept-url"},
"https://url.spec.whatwg.org/#concept-url-origin": {"displayText":"origin","export":true,"for_":["url"],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"origin","type":"dfn","url":"https://url.spec.whatwg.org/#concept-url-origin"},
"https://url.spec.whatwg.org/#concept-url-parser": {"displayText":"URL parser","export":true,"for_":[],"level":"1","normative":true,"shortname":"url","spec":"url","status":"current","text":"url parser","type":"dfn","url":"https://url.spec.whatwg.org/#concept-url-parser"},
"https://urlpattern.spec.whatwg.org/#build-a-url-pattern-from-an-http-structured-field-value": {"displayText":"build a URL pattern from an HTTP structured field value","export":true,"for_":[],"level":"1","normative":true,"shortname":"urlpattern","spec":"urlpattern","status":"current","text":"build a url pattern from an http structured field value","type":"dfn","url":"https://urlpattern.spec.whatwg.org/#build-a-url-pattern-from-an-http-structured-field-value"},
"https://urlpattern.spec.whatwg.org/#dictdef-urlpatterninit": {"displayText":"URLPatternInit","export":true,"for_":[],"level":"1","normative":true,"shortname":"urlpattern","spec":"urlpattern","status":"current","text":"URLPatternInit","type":"dictionary","url":"https://urlpattern.spec.whatwg.org/#dictdef-urlpatterninit"},
"https://urlpattern.spec.whatwg.org/#dom-urlpatterninit-hostname": {"displayText":"hostname","export":true,"for_":["URLPatternInit"],"level":"1","normative":true,"shortname":"urlpattern","spec":"urlpattern","status":"current","text":"hostname","type":"dict-member","url":"https://urlpattern.spec.whatwg.org/#dom-urlpatterninit-hostname"},
"https://urlpattern.spec.whatwg.org/#url-pattern": {"displayText":"URL pattern","export":true,"for_":[],"level":"1","normative":true,"shortname":"urlpattern","spec":"urlpattern","status":"current","text":"url pattern","type":"dfn","url":"https://urlpattern.spec.whatwg.org/#url-pattern"},
"https://urlpattern.spec.whatwg.org/#url-pattern-create": {"displayText":"create","export":true,"for_":["URL pattern"],"level":"1","normative":true,"shortname":"urlpattern","spec":"urlpattern","status":"current","text":"create","type":"dfn","url":"https://urlpattern.spec.whatwg.org/#url-pattern-create"},
"https://urlpattern.spec.whatwg.org/#url-pattern-hostname-component": {"displayText":"hostname component","export":false,"for_":["URL pattern"],"level":"1","normative":true,"shortname":"urlpattern","spec":"urlpattern","status":"current","text":"hostname component","type":"dfn","url":"https://urlpattern.spec.whatwg.org/#url-pattern-hostname-component"},
"https://urlpattern.spec.whatwg.org/#url-pattern-match": {"displayText":"match","export":true,"for_":["URL pattern"],"level":"1","normative":true,"shortname":"urlpattern","spec":"urlpattern","status":"current","text":"match","type":"dfn","url":"https://urlpattern.spec.whatwg.org/#url-pattern-match"},
"https://w3c.github.io/reporting/#endpoint": {"displayText":"endpoint","export":true,"for_":[],"level":"1","normative":true,"shortname":"reporting","spec":"reporting-1","status":"current","text":"endpoint","type":"dfn","url":"https://w3c.github.io/reporting/#endpoint"},
"https://w3c.github.io/reporting/#generate-and-queue-a-report": {"displayText":"generate and queue a report","export":true,"for_":[],"level":"1","normative":true,"shortname":"reporting","spec":"reporting-1","status":"current","text":"generate and queue a report","type":"dfn","url":"https://w3c.github.io/reporting/#generate-and-queue-a-report"},
"https://w3c.github.io/reporting/#reportbody": {"displayText":"ReportBody","export":true,"for_":[],"level":"1","normative":true,"shortname":"reporting","spec":"reporting-1","status":"current","text":"ReportBody","type":"dictionary","url":"https://w3c.github.io/reporting/#reportbody"},
"https://w3c.github.io/reporting/#reporting-endpoints": {"displayText":"Reporting-Endpoints","export":true,"for_":[],"level":"1","normative":true,"shortname":"reporting","spec":"reporting-1","status":"current","text":"reporting-endpoints","type":"dfn","url":"https://w3c.github.io/reporting/#reporting-endpoints"},
"https://w3c.github.io/reporting/#strip-url-for-use-in-reports": {"displayText":"strip URL for use in reports","export":true,"for_":[],"level":"1","normative":true,"shortname":"reporting","spec":"reporting-1","status":"current","text":"strip url for use in reports","type":"dfn","url":"https://w3c.github.io/reporting/#strip-url-for-use-in-reports"},
"https://w3c.github.io/webappsec-csp/#fetch-directives": {"displayText":"fetch directives","export":true,"for_":[],"level":"3","normative":true,"shortname":"csp","spec":"csp3","status":"current","text":"fetch directives","type":"dfn","url":"https://w3c.github.io/webappsec-csp/#fetch-directives"},
"https://w3c.github.io/webappsec-csp/#grammardef-host-source": {"displayText":"host-source","export":true,"for_":[],"level":"3","normative":true,"shortname":"csp","spec":"csp3","status":"current","text":"host-source","type":"grammar","url":"https://w3c.github.io/webappsec-csp/#grammardef-host-source"},
"https://webidl.spec.whatwg.org/#idl-DOMString": {"displayText":"DOMString","export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"DOMString","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-DOMString"},
"https://webidl.spec.whatwg.org/#idl-USVString": {"displayText":"USVString","export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"USVString","type":"interface","url":"https://webidl.spec.whatwg.org/#idl-USVString"},
"https://webidl.spec.whatwg.org/#idl-sequence": {"displayText":"sequence","export":true,"for_":[],"level":"1","normative":true,"shortname":"webidl","spec":"webidl","status":"current","text":"sequence","type":"dfn","url":"https://webidl.spec.whatwg.org/#idl-sequence"},
"https://www.rfc-editor.org/rfc/rfc9651#name-inner-list": {"displayText":"inner list","export":true,"for_":["structured header"],"level":"","normative":true,"shortname":"rfc9651","spec":"rfc9651","status":"anchor-block","text":"inner list","type":"dfn","url":"https://www.rfc-editor.org/rfc/rfc9651#name-inner-list"},
"https://www.rfc-editor.org/rfc/rfc9651#name-introduction": {"displayText":"structured header","export":true,"for_":[],"level":"","normative":true,"shortname":"rfc9651","spec":"rfc9651","status":"anchor-block","text":"structured header","type":"dfn","url":"https://www.rfc-editor.org/rfc/rfc9651#name-introduction"},
"https://www.rfc-editor.org/rfc/rfc9651#name-list": {"displayText":"list","export":true,"for_":["structured header"],"level":"","normative":true,"shortname":"rfc9651","spec":"rfc9651","status":"anchor-block","text":"list","type":"dfn","url":"https://www.rfc-editor.org/rfc/rfc9651#name-list"},
"https://www.rfc-editor.org/rfc/rfc9651#name-parameters": {"displayText":"parameters","export":true,"for_":["structured header"],"level":"","normative":true,"shortname":"rfc9651","spec":"rfc9651","status":"anchor-block","text":"parameters","type":"dfn","url":"https://www.rfc-editor.org/rfc/rfc9651#name-parameters"},
"https://www.rfc-editor.org/rfc/rfc9651#name-string": {"displayText":"string","export":true,"for_":["structured header"],"level":"","normative":true,"shortname":"rfc9651","spec":"rfc9651","status":"anchor-block","text":"string","type":"dfn","url":"https://www.rfc-editor.org/rfc/rfc9651#name-string"},
"https://www.rfc-editor.org/rfc/rfc9651#name-tokens": {"displayText":"token","export":true,"for_":["structured header"],"level":"","normative":true,"shortname":"rfc9651","spec":"rfc9651","status":"anchor-block","text":"token","type":"dfn","url":"https://www.rfc-editor.org/rfc/rfc9651#name-tokens"},
"https://xhr.spec.whatwg.org/#xmlhttprequest": {"displayText":"XMLHttpRequest","export":true,"for_":[],"level":"1","normative":true,"shortname":"xhr","spec":"xhr","status":"current","text":"XMLHttpRequest","type":"interface","url":"https://xhr.spec.whatwg.org/#xmlhttprequest"},
};

function mkRefHint(link, ref) {
    const linkText = link.textContent;
    let dfnTextElements = '';
    if (ref.displayText.toLowerCase() != linkText.toLowerCase()) {
        // Give the original term if it's being displayed in a different way.
        // But allow casing differences, they're insignificant.
        dfnTextElements =
            mk.li({},
                mk.b({}, "Term: "),
                mk.span({}, ref.displayText)
            );
    }
    const forList = ref.for_;
    let forListElements;
    if(forList.length == 0) {
        forListElements = [];
    } else if(forList.length == 1) {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.span({}, forList[0]),
        );
    } else {
        forListElements = mk.li({},
            mk.b({}, "For: "),
            mk.ul({},
                ...forList.map(forItem =>
                    mk.li({},
                        mk.span({}, forItem)
                    ),
                ),
            ),
        );
    }
    const url = ref.url;
    const safeUrl = encodeURIComponent(url);
    const hintPanel = mk.aside({
        class: "ref-hint",
        id: `ref-hint-for-${safeUrl}`,
        "data-for": url,
        "aria-labelled-by": `ref-hint-for-${safeUrl}`,
    },
        mk.ul({},
            dfnTextElements,
            mk.li({},
                mk.b({}, "URL: "),
                mk.a({ href: url, class: "ref" }, url),
            ),
            mk.li({},
                mk.b({}, "Type: "),
                mk.span({}, `${ref.type}`),
            ),
            mk.li({},
                mk.b({}, "Spec: "),
                mk.span({}, `${ref.spec ? ref.spec : ''}`),
            ),
            forListElements
        ),
    );
    hintPanel.forLink = link;
    setupRefHintEventListeners(link, hintPanel);
    return hintPanel;
}

function hideAllRefHints() {
    queryAll(".ref-hint").forEach(el=>hideRefHint(el));
}

function hideRefHint(refHint) {
    const link = refHint.forLink;
    link.setAttribute("aria-expanded", "false");
    if(refHint.teardownEventListeners) {
        refHint.teardownEventListeners();
    }
    refHint.remove();
}

function showRefHint(link) {
    if(link.classList.contains("dfn-link")) return;
    const url = link.getAttribute("href");
    const refHintKey = link.getAttribute("data-refhint-key");
    let key = url;
    if(refHintKey) {
        key = refHintKey + "_" + url;
    }
    const ref = refsData[key];
    if(!ref) return;

    hideAllRefHints(); // Only display one at this time.

    const refHint = mkRefHint(link, ref);
    append(document.body, refHint);
    link.setAttribute("aria-expanded", "true");
    positionRefHint(refHint);
}

function setupRefHintEventListeners(link, refHint) {
    if (refHint.teardownEventListeners) return;
    // Add event handlers to hide the refHint after the user moves away
    // from both the link and refHint, if not hovering either within one second.
    let timeout = null;
    const startHidingRefHint = (event) => {
        if (timeout) {
            clearTimeout(timeout);
        }
        timeout = setTimeout(() => {
            hideRefHint(refHint);
        }, 1000);
    }
    const resetHidingRefHint = (event) => {
        if (timeout) clearTimeout(timeout);
        timeout = null;
    };
    link.addEventListener("mouseleave", startHidingRefHint);
    link.addEventListener("mouseenter", resetHidingRefHint);
    link.addEventListener("blur", startHidingRefHint);
    link.addEventListener("focus", resetHidingRefHint);
    refHint.addEventListener("mouseleave", startHidingRefHint);
    refHint.addEventListener("mouseenter", resetHidingRefHint);
    refHint.addEventListener("blur", startHidingRefHint);
    refHint.addEventListener("focus", resetHidingRefHint);

    refHint.teardownEventListeners = () => {
        // remove event listeners
        resetHidingRefHint();
        link.removeEventListener("mouseleave", startHidingRefHint);
        link.removeEventListener("mouseenter", resetHidingRefHint);
        link.removeEventListener("blur", startHidingRefHint);
        link.removeEventListener("focus", resetHidingRefHint);
        refHint.removeEventListener("mouseleave", startHidingRefHint);
        refHint.removeEventListener("mouseenter", resetHidingRefHint);
        refHint.removeEventListener("blur", startHidingRefHint);
        refHint.removeEventListener("focus", resetHidingRefHint);
    };
}

function positionRefHint(refHint) {
    const link = refHint.forLink;
    const linkPos = getBounds(link);
    refHint.style.top = linkPos.bottom + "px";
    refHint.style.left = linkPos.left + "px";

    const panelPos = refHint.getBoundingClientRect();
    const panelMargin = 8;
    const maxRight = document.body.parentNode.clientWidth - panelMargin;
    if (panelPos.right > maxRight) {
        const overflowAmount = panelPos.right - maxRight;
        const newLeft = Math.max(panelMargin, linkPos.left - overflowAmount);
        refHint.style.left = newLeft + "px";
    }
}

// TODO: shared util
// Returns the root-level absolute position {left and top} of element.
function getBounds(el, relativeTo=document.body) {
    const relativeRect = relativeTo.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const top = elRect.top - relativeRect.top;
    const left = elRect.left - relativeRect.left;
    return {
        top,
        left,
        bottom: top + elRect.height,
        right: left + elRect.width,
    }
}

function showRefHintListener(e) {
    // If the target isn't in a link (or is a link),
    // just ignore it.
    let link = e.target.closest("a");
    if(!link) return;

    // If the target is in a ref-hint panel
    // (aka a link in the already-open one),
    // also just ignore it.
    if(link.closest(".ref-hint")) return;

    // Otherwise, show the panel for the link.
    showRefHint(link);
}

function hideAllHintsListener(e) {
    // If the click is inside a ref-hint panel, ignore it.
    if(e.target.closest(".ref-hint")) return;
    // Otherwise, close all the current panels.
    hideAllRefHints();
}

document.addEventListener("DOMContentLoaded", () => {
    document.body.addEventListener("mousedown", showRefHintListener);
    document.body.addEventListener("focus", showRefHintListener);

    document.body.addEventListener("click", hideAllHintsListener);
});

window.addEventListener("resize", () => {
    // Hide any open ref hint.
    hideAllRefHints();
});
}
</script>
<script>/* Boilerplate: script-var-click-highlighting */
"use strict";
{
/*
Color-choosing design:

* Colors are ordered by goodness.
* On clicking a var, give it the earliest color
    with the lowest usage in the algorithm.
* On re-clicking, re-use the var's most recent color
    if that's not currently being used elsewhere.
*/

const COLOR_COUNT = 7;

document.addEventListener("click", e=>{
    if(e.target.nodeName == "VAR") {
        highlightSameAlgoVars(e.target);
    }
});

function highlightSameAlgoVars(v) {
    // Find the algorithm container.
    let algoContainer = findAlgoContainer(v);

    // Not highlighting document-global vars,
    // too likely to be unrelated.
    if(algoContainer == null) return;

    const varName = nameFromVar(v);
    if(!v.hasAttribute("data-var-color")) {
        const newColor = chooseHighlightColor(algoContainer, v);
        for(const el of algoContainer.querySelectorAll("var")) {
            if(nameFromVar(el) == varName) {
                el.setAttribute("data-var-color", newColor);
                el.setAttribute("data-var-last-color", newColor);
            }
        }
    } else {
        for(const el of algoContainer.querySelectorAll("var")) {
            if(nameFromVar(el) == varName) {
                el.removeAttribute("data-var-color");
            }
        }
    }
}
function findAlgoContainer(el) {
    while(el != document.body) {
        if(el.hasAttribute("data-algorithm")) return el;
        el = el.parentNode;
    }
    return null;
}
function nameFromVar(el) {
    return el.textContent.replace(/(\s|\xa0)+/g, " ").trim();
}
function colorCountsFromContainer(container) {
    const namesFromColor = Array.from({length:COLOR_COUNT}, x=>new Set());
    for(let v of container.querySelectorAll("var[data-var-color]")) {
        let color = +v.getAttribute("data-var-color");
        namesFromColor[color].add(nameFromVar(v));
    }

    return namesFromColor.map(x=>x.size);
}
function leastUsedColor(colors) {
    // Find the earliest color with the lowest count.
    let minCount = Infinity;
    let minColor = null;
    for(var i = 0; i < colors.length; i++) {
        if(colors[i] < minCount) {
            minColor = i;
            minCount = colors[i];
        }
    }
    return minColor;
}
function chooseHighlightColor(container, v) {
    const colorCounts = colorCountsFromContainer(container);
    if(v.hasAttribute("data-var-last-color")) {
        let color = +v.getAttribute("data-var-last-color");
        if(colorCounts[color] == 0) return color;
    }
    return leastUsedColor(colorCounts);
}
}
</script>